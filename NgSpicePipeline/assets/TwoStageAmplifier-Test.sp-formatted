circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.9997036457061766e-05 3.000654399394989e-05 3.0009772777557372e-05 2.9999375939369203e-05 2.9989030361175536e-05 3.0007030963897705e-05 2.880310773849487e-05 3.000614821910858e-05 3.001731812953949e-05 2.8934767842292787e-05 3.000571310520172e-05 3.002304255962372e-05 2.999586760997772e-05 2.9968435168266295e-05 2.882144808769226e-05 3.000640571117401e-05 2.999884605407715e-05 3.0061333775520324e-05 3.0136083364486695e-05 2.999306321144104e-05 2.995248556137085e-05 2.8445739150047304e-05 2.9993686079978944e-05 3.001467287540436e-05 2.993160843849182e-05 2.996790885925293e-05 2.9992370009422302e-05 2.5535671114921572e-05 2.9998029470443724e-05 3.008603274822235e-05 2.9986265897750853e-05 2.9997358918190003e-05 3.0007124543190003e-05 3.0002509355545045e-05 2.9967823624610902e-05 3.0004382133483886e-05 3.0015811324119568e-05 3.0014957785606384e-05 3.0000594854354858e-05 3.0008206963539122e-05 3.0000335574150086e-05 3.002006232738495e-05 3.0004155039787292e-05 3.0012814998626708e-05 3.000927925109863e-05 3.0005548000335693e-05 3.0036388039588927e-05 3.0031391382217408e-05 3.000598132610321e-05 2.9999059438705445e-05 2.998919367790222e-05 2.5541106313467027e-05 3.0015708804130556e-05 3.0030914545059206e-05 3.00062096118927e-05 2.9995088577270508e-05 2.9996525645256043e-05 3.002659022808075e-05 3.0015289783477782e-05 3.0030384063720702e-05 )
set w1_array = ( 6.0195061415433884e-06 6.014583095908165e-06 6.016600731760263e-06 6.0192021485418085e-06 6.01820239238441e-06 6.0174426753073934e-06 6.0272918399423365e-06 6.017549740150571e-06 6.0153627432882784e-06 6.006808554753661e-06 6.009585581719876e-06 6.008652713149786e-06 6.0125338695943355e-06 6.007516760379076e-06 6.023841187357902e-06 6.017521809786558e-06 6.012472476810217e-06 6.004562605172396e-06 6.004106555134058e-06 6.019966177642345e-06 6.011683274060488e-06 6.009415987879038e-06 6.02034168690443e-06 6.012949351221323e-06 6.005388390272856e-06 6.011902526021004e-06 6.0139044038951395e-06 6.020589726045728e-06 6.015260558575392e-06 6.004105819389224e-06 6.020832717418671e-06 6.012511126697064e-06 6.013387259095907e-06 6.018440829589963e-06 6.0127056241035465e-06 6.014112032949925e-06 6.0145522225648165e-06 6.0138751976191996e-06 6.017301496118307e-06 6.0153351295739416e-06 6.012419251725078e-06 6.01636459492147e-06 6.012419475242495e-06 6.017847837880254e-06 6.005831383168697e-06 6.018014814704656e-06 6.009630024433136e-06 6.0119584891945125e-06 6.016417605802417e-06 6.018596034497023e-06 6.020684134215117e-06 6.0350066740065815e-06 6.012754518538714e-06 6.0115732476115224e-06 6.0171195529401305e-06 6.017380369827151e-06 6.0190293416380885e-06 6.004741456359625e-06 6.01385422423482e-06 6.013303570449352e-06 )
set w2_array = ( 5.2012840799987315e-05 5.20075292866677e-05 5.201393174566328e-05 5.2013242425397036e-05 5.2009917421266434e-05 5.2014143465086816e-05 5.5638900458812716e-05 5.2014175513759254e-05 5.200637721642852e-05 5.256707958877086e-05 5.200077889487147e-05 5.201847405172884e-05 5.2000665681436653e-05 5.205951378494501e-05 5.4779835402965546e-05 5.201417023316026e-05 5.2000584255903955e-05 5.238788145780563e-05 5.272336722165346e-05 5.201137639209628e-05 5.197653415240347e-05 5.309509818255901e-05 5.2008202908560635e-05 5.2006371779367325e-05 5.277533770352602e-05 5.197934869863093e-05 5.2003440095111724e-05 5.366372413933277e-05 5.2006318934261796e-05 5.240977755934e-05 5.200806206651032e-05 5.2000632354989644e-05 5.200450818426907e-05 5.2013838103041054e-05 5.1982580360025165e-05 5.200343115068972e-05 5.201016171090305e-05 5.200892993621528e-05 5.2009171722456814e-05 5.20087653901428e-05 5.2000525947660204e-05 5.200803063064814e-05 5.200005229748786e-05 5.2009059669449926e-05 5.2177689000964164e-05 5.2013985633850095e-05 5.200655015930533e-05 5.199954713322222e-05 5.201061053574085e-05 5.2011910658329724e-05 5.201091013476252e-05 5.4647830337285996e-05 5.200567750446498e-05 5.199253666214645e-05 5.200901725515723e-05 5.200919203646481e-05 5.201194596663117e-05 5.239457908272743e-05 5.20086751896888e-05 5.199817962758243e-05 )
set i = 60
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc