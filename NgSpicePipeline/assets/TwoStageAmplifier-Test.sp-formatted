circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.9973091781139372e-05 2.998367637395859e-05 2.9979830980300902e-05 2.9986971616744994e-05 2.9978896975517272e-05 2.999187171459198e-05 2.7739051282405853e-05 2.9979952573776245e-05 2.9975909292697907e-05 2.9972606599330903e-05 2.743976503610611e-05 2.9976150393486024e-05 2.9962257742881774e-05 2.997970461845398e-05 2.998456686735153e-05 2.9983887672424316e-05 2.9783461689949034e-05 2.9979608654975892e-05 2.6546747535467148e-05 2.999427914619446e-05 2.9971937537193297e-05 2.9981132447719574e-05 2.9989008009433747e-05 2.997709393501282e-05 2.9973831474781038e-05 3.002964496612549e-05 2.9968422949314116e-05 2.996927499771118e-05 2.998686671257019e-05 2.9962689876556396e-05 2.998584985733032e-05 2.9973447322845458e-05 2.996997892856598e-05 2.9885801672935486e-05 2.9981794953346253e-05 2.998898208141327e-05 2.9974710941314697e-05 2.9980738759040833e-05 2.9963523149490356e-05 2.9868953824043273e-05 2.997563123703003e-05 2.998060464859009e-05 3.0012237429618836e-05 2.997564733028412e-05 2.9978204369544982e-05 2.9984259605407713e-05 2.9984994232654572e-05 2.9056867063045502e-05 3.0145728588104247e-05 2.9983699023723603e-05 2.9983995854854584e-05 2.9984036087989808e-05 2.8586609959602355e-05 )
set w1_array = ( 6.014939215034247e-06 6.015802513808012e-06 6.01547240652144e-06 6.015961360186338e-06 6.015443963930011e-06 6.016412176191807e-06 5.9819706007838245e-06 6.0159824453294275e-06 6.015279091894626e-06 6.01483840867877e-06 5.983083158731461e-06 6.015242761000991e-06 6.009828545153141e-06 6.015504322946072e-06 6.0163045339286324e-06 6.015670564025641e-06 6.0119949132204055e-06 6.0154666975140576e-06 5.981625461950898e-06 6.012251595035196e-06 6.014839936047793e-06 6.012992788106203e-06 6.0164612382650376e-06 6.015363972634077e-06 6.015156669542193e-06 6.007872302085161e-06 6.014914702624083e-06 6.014575999230146e-06 6.0160149578005076e-06 6.014138733968139e-06 6.015656966716051e-06 6.015765447169543e-06 6.0055170431733136e-06 6.007879994809628e-06 6.014872131869197e-06 6.013647964224219e-06 6.015272311866283e-06 6.015903878957033e-06 6.016012499108911e-06 6.0132540054619315e-06 6.015056077390909e-06 6.016355402767659e-06 6.007160101085902e-06 6.01500315964222e-06 6.015262579545379e-06 6.016114171594381e-06 6.015799067914486e-06 5.953565075993538e-06 5.996935613453388e-06 6.014892052859068e-06 6.012865988537669e-06 6.015843156725168e-06 5.9935540277510886e-06 )
set w2_array = ( 5.199455104768276e-05 5.199727364629507e-05 5.1988650050014255e-05 5.1995750786736606e-05 5.199308184161782e-05 5.19952181763947e-05 5.351071006059647e-05 5.2007536392658946e-05 5.198979578353464e-05 5.199197369813919e-05 5.213536780327558e-05 5.19973309636116e-05 5.2082455236464736e-05 5.199147427082062e-05 5.200688767433167e-05 5.1981042271479966e-05 5.1934536792337896e-05 5.1989726092666386e-05 5.244759473204612e-05 5.2054828342050314e-05 5.1992842245846986e-05 5.202685333229601e-05 5.200135558843612e-05 5.199867857247591e-05 5.19989543762058e-05 5.218845495581627e-05 5.1988662384450435e-05 5.198755936510861e-05 5.1996683822944757e-05 5.199217201396823e-05 5.1990929873660204e-05 5.201117087900639e-05 5.227965622022748e-05 5.2130059849470856e-05 5.198973019979894e-05 5.201295375265181e-05 5.1987468317151066e-05 5.1986335974186656e-05 5.1994472673162814e-05 5.195332269929349e-05 5.1992405964061615e-05 5.2009916573762895e-05 5.221496361494064e-05 5.1986952278763053e-05 5.198889178410172e-05 5.200430014170706e-05 5.199014893174171e-05 5.482395398616791e-05 5.269105553627014e-05 5.198849285766482e-05 5.2031706541776654e-05 5.199550760537386e-05 5.218852197378874e-05 )
set i = 53
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc