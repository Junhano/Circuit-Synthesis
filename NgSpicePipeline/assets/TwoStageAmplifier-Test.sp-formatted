circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 3.0012569427490234e-05 3.0015958547592164e-05 3.0011814832687378e-05 3.0013272762298583e-05 3.0016955137252806e-05 3.0014382004737854e-05 3.0010606050491332e-05 3.00095009803772e-05 3.0015230178833008e-05 3.0012758374214172e-05 3.001588761806488e-05 2.9587386548519135e-05 3.0013133883476258e-05 3.0013128519058228e-05 3.001433849334717e-05 3.00156170129776e-05 2.5082481279969218e-05 3.0012612342834472e-05 3.000466525554657e-05 3.0013737082481383e-05 3.0010668039321898e-05 2.9939466416835786e-05 2.8988288938999176e-05 3.001461148262024e-05 3.001516044139862e-05 3.001286804676056e-05 3.0004847645759582e-05 3.001591682434082e-05 3.0013277530670166e-05 2.5626216754317286e-05 2.600644052028656e-05 3.0008009672164916e-05 2.992960751056671e-05 3.0006244778633117e-05 3.0013064742088317e-05 3.0011778473854066e-05 3.0009762048721313e-05 3.001189410686493e-05 3.001287281513214e-05 2.6098795607686042e-05 3.0005748271942138e-05 3.0012807250022887e-05 3.001534104347229e-05 3.0013737678527833e-05 3.0012022256851198e-05 3.001249313354492e-05 3.0015255212783815e-05 2.751613885164261e-05 3.0019555687904357e-05 2.711289554834366e-05 3.001290738582611e-05 2.9997985064983367e-05 2.710614025592804e-05 )
set w1_array = ( 5.9904479621909555e-06 5.990507387556136e-06 5.990246680099517e-06 5.990574198309332e-06 5.990093705710024e-06 5.9906473560258744e-06 5.989877250045538e-06 5.990795461926609e-06 5.990214044228196e-06 5.9905148753896355e-06 5.990520903375e-06 5.990322599187494e-06 5.990503257140518e-06 5.990502297878265e-06 5.990410257596523e-06 5.990454376675189e-06 6.0174725544638934e-06 5.990807508584112e-06 5.990279623307288e-06 5.990627085790038e-06 5.990413882769644e-06 5.9936833744868635e-06 6.000363655854017e-06 5.990463447757065e-06 5.9906615633517504e-06 5.990180928725749e-06 5.989758871961385e-06 5.990399477537721e-06 5.990261958446354e-06 6.020715130958706e-06 6.010062598157674e-06 5.98853610130027e-06 5.991329333279282e-06 5.989509414881468e-06 5.990464500151575e-06 5.990293544251472e-06 5.989841307979077e-06 5.990197659935802e-06 5.990050012711436e-06 6.015503962058574e-06 5.990475245285779e-06 5.990285651292652e-06 5.9905036552809175e-06 5.990697458852083e-06 5.990146402269602e-06 5.9902141164056955e-06 5.990413659252226e-06 6.0022254046052696e-06 5.988507791422307e-06 6.013746449258178e-06 5.99045706121251e-06 5.987871204502881e-06 6.016672008205205e-06 )
set w2_array = ( 5.198389331740327e-05 5.19818576790858e-05 5.198309671948664e-05 5.1984017933020366e-05 5.197717458964325e-05 5.198287996719591e-05 5.1982607716461645e-05 5.198512159124948e-05 5.1980550988344475e-05 5.198449194175191e-05 5.198226120811887e-05 5.27050706371665e-05 5.198390509118326e-05 5.198357416712679e-05 5.1982857087859884e-05 5.1983373321825636e-05 5.263989062607288e-05 5.198158893245272e-05 5.198608624585904e-05 5.198264281288721e-05 5.19801623004023e-05 5.5713930547237397e-05 5.5223236948251726e-05 5.19831177147571e-05 5.198166432441212e-05 5.198365851980634e-05 5.1982248273910956e-05 5.198188020312227e-05 5.198282671137713e-05 5.513865348696709e-05 5.2661743596196177e-05 5.259132277965545e-05 5.47392330467701e-05 5.198369283718057e-05 5.1983863847097384e-05 5.198306876164861e-05 5.198207499203272e-05 5.198313815915026e-05 5.19834682943765e-05 5.465791067481041e-05 5.198522182158194e-05 5.1983854061691086e-05 5.198203876451589e-05 5.1984830402070656e-05 5.198319593933411e-05 5.198320931359194e-05 5.198076857835986e-05 5.210264554154128e-05 5.26094890832901e-05 5.517183557152748e-05 5.1984220395097506e-05 5.3094835847616195e-05 5.5634621739387516e-05 )
set i = 53
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc