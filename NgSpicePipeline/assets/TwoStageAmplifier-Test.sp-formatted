circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.9979219734668732e-05 2.9985044598579406e-05 2.9675976932048797e-05 3.0009782314300536e-05 2.9985099732875822e-05 2.998863607645035e-05 2.9975537061691286e-05 2.9983252882957458e-05 2.9986488223075866e-05 3.0009300112724304e-05 2.9990995824337005e-05 3.0020505785942077e-05 3.0000389218330384e-05 3.0013716220855714e-05 2.9969718754291535e-05 3.000645637512207e-05 3.0011937618255614e-05 2.9995419681072236e-05 2.999379336833954e-05 2.998988300561905e-05 2.9992063343524934e-05 3.0018646121025084e-05 2.704794079065323e-05 2.9994238317012786e-05 2.9962105453014375e-05 3.0002104043960572e-05 2.9994321167469025e-05 2.9993132650852202e-05 2.9994477927684784e-05 2.999552011489868e-05 2.9997064769268038e-05 2.9999898076057435e-05 2.9984575808048248e-05 2.9985455274581908e-05 2.997562915086746e-05 2.9963826835155486e-05 2.998877823352814e-05 2.9994632303714753e-05 2.999058485031128e-05 2.9994786083698274e-05 3.0003103613853456e-05 2.997976690530777e-05 2.994358569383621e-05 3.0012274384498595e-05 3.0023263096809388e-05 2.9084318578243255e-05 2.8721007406711578e-05 2.6620548069477083e-05 2.9999779760837556e-05 2.9625533819198608e-05 2.9078507125377656e-05 3.000941276550293e-05 3.000250220298767e-05 )
set w1_array = ( 5.9912730464711786e-06 5.990676795132458e-06 6.0004209065809846e-06 5.991670507006347e-06 5.99116484541446e-06 5.991262019611895e-06 5.990534274838865e-06 5.9907909939065575e-06 5.9911545822396876e-06 5.99174443539232e-06 5.99093669001013e-06 5.991138721816242e-06 5.991920390166343e-06 5.989818376488984e-06 5.990890235640109e-06 5.991802521981299e-06 5.99026367906481e-06 5.991051848046482e-06 5.991151806898415e-06 5.991645482368768e-06 5.991628830321133e-06 5.990457338280976e-06 6.012236698530614e-06 5.991404288448393e-06 5.992459896020591e-06 5.990476784296334e-06 5.99137754086405e-06 5.991821427829564e-06 5.991066013462841e-06 5.992007804103196e-06 5.990454590879381e-06 5.9916308233514425e-06 5.990779110230506e-06 5.99085342977196e-06 5.989563417620957e-06 5.990580794401467e-06 5.9909598426893354e-06 5.991235542111098e-06 5.991094288416207e-06 5.991235234774649e-06 5.990761843509972e-06 5.991085235960782e-06 5.988917340524495e-06 5.9913218198344115e-06 5.990388448350131e-06 6.000175484456122e-06 6.0015954719856385e-06 6.014684260822833e-06 5.991537579335272e-06 5.990207315422594e-06 5.995811437256634e-06 5.991689291782677e-06 5.991481867618859e-06 )
set w2_array = ( 5.213906929455697e-05 5.202468235255219e-05 5.4671548128128056e-05 5.2036958948243405e-05 5.202038423507474e-05 5.201733115245588e-05 5.2042280233930795e-05 5.203584756143391e-05 5.20204606896732e-05 5.203597863111645e-05 5.2019999693380666e-05 5.2022445106180386e-05 5.2036887308117004e-05 5.220944107323885e-05 5.204243025183678e-05 5.203646509163082e-05 5.2026896116556596e-05 5.202073098788969e-05 5.201642016111873e-05 5.201792440819554e-05 5.201829526270739e-05 5.2017114426242184e-05 5.446960467100144e-05 5.202048363746144e-05 5.278529845178127e-05 5.202893912652507e-05 5.201579305087216e-05 5.202343267924152e-05 5.202072017895989e-05 5.203655449021607e-05 5.205913950782269e-05 5.203007974568754e-05 5.203563572466373e-05 5.2025412512710315e-05 5.229522141814232e-05 5.2064121309667825e-05 5.2019871831173076e-05 5.2022792595671486e-05 5.20170886523556e-05 5.201790224923752e-05 5.2016970024676995e-05 5.201868080184795e-05 5.213365918397903e-05 5.2021534095285456e-05 5.202048869966529e-05 5.409255373477936e-05 5.406259977817535e-05 5.445736828446388e-05 5.2019249206176024e-05 5.231261683255434e-05 5.305718530714512e-05 5.20301865702495e-05 5.202517597773112e-05 )
set i = 53
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc