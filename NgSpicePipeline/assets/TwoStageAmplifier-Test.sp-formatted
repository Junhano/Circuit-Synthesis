circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.9276951253414155e-05 2.9276951253414155e-05 2.8145846873521805e-05 2.8145846873521805e-05 2.8224373906850814e-05 2.8224373906850814e-05 2.620385527610779e-05 2.620385527610779e-05 2.5936528742313384e-05 2.5936528742313384e-05 2.870043858885765e-05 2.870043858885765e-05 2.8442055135965346e-05 2.8442055135965346e-05 2.5951332151889803e-05 2.5951332151889803e-05 2.8561002016067505e-05 2.8561002016067505e-05 2.636829674243927e-05 2.636829674243927e-05 )
set w1_array = ( 5.565495997667313e-06 5.565495997667313e-06 6.210626795887947e-06 6.210626795887947e-06 5.7018994390964506e-06 5.7018994390964506e-06 6.172148644924164e-06 6.172148644924164e-06 7.2010566005483264e-06 7.2010566005483264e-06 5.774916023015976e-06 5.774916023015976e-06 6.146473422646522e-06 6.146473422646522e-06 8.093669399619103e-06 8.093669399619103e-06 5.707210212945938e-06 5.707210212945938e-06 7.266185825224966e-06 7.266185825224966e-06 )
set w2_array = ( 5.554275590181351e-05 5.554275590181351e-05 5.492968080937863e-05 5.492968080937863e-05 5.542339871823788e-05 5.542339871823788e-05 5.458812801539898e-05 5.458812801539898e-05 5.383900666702539e-05 5.383900666702539e-05 5.506939800083637e-05 5.506939800083637e-05 5.4955851405858994e-05 5.4955851405858994e-05 5.2963634684681893e-05 5.2963634684681893e-05 5.541765697300434e-05 5.541765697300434e-05 5.3518263194710016e-05 5.3518263194710016e-05 )
set i = 20
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc