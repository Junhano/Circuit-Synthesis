circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 3.004530429840088e-05 3.001273214817047e-05 3.0034587383270265e-05 3.0009567141532898e-05 3.0091697573661805e-05 3.006696879863739e-05 3.0048727989196778e-05 3.0034000277519226e-05 3.003303349018097e-05 3.0077269077301026e-05 3.0053024888038636e-05 2.538298100233078e-05 3.0108455419540404e-05 3.0059497952461242e-05 3.013696789741516e-05 3.009617030620575e-05 2.9719367623329162e-05 3.002223551273346e-05 2.9792354702949523e-05 3.006047010421753e-05 3.006563901901245e-05 3.0065190196037292e-05 2.550774808973074e-05 3.015230178833008e-05 3.0046322345733642e-05 3.0083746910095215e-05 3.0025777220726012e-05 3.0061519145965575e-05 3.0119413137435914e-05 3.007728576660156e-05 3.0143282413482668e-05 3.0042727589607237e-05 2.985737055540085e-05 3.010136067867279e-05 3.0023056268692017e-05 2.994931310415268e-05 3.0075109004974364e-05 3.011099576950073e-05 3.0101872086524965e-05 3.014164447784424e-05 3.0039907693862915e-05 3.0029317140579223e-05 3.0014103651046755e-05 2.9992104172706604e-05 3.003097593784332e-05 3.0037301778793334e-05 3.0021421909332276e-05 3.0057284832000732e-05 2.9031755924224854e-05 3.0124919414520264e-05 3.0062086582183837e-05 3.0035770535469055e-05 3.00362229347229e-05 2.6369994580745697e-05 3.0146207213401794e-05 3.0148379802703858e-05 3.006465017795563e-05 3.0018105506896974e-05 2.6289450228214264e-05 3.009399652481079e-05 3.0017353892326357e-05 3.0098369121551513e-05 2.9986360669136047e-05 3.0029456615447997e-05 3.005515933036804e-05 3.0005000233650208e-05 3.007682740688324e-05 3.0049458742141723e-05 3.00147944688797e-05 2.809975177049637e-05 3.0040118098258973e-05 3.008646845817566e-05 3.0098677277565003e-05 3.0057093501091005e-05 2.4942130520939826e-05 3.004817545413971e-05 3.0032795667648314e-05 3.0126914978027344e-05 3.0027552843093874e-05 3.0089747309684752e-05 2.9913038611412048e-05 3.0028254389762877e-05 3.0039232969284057e-05 3.00337153673172e-05 2.827494353055954e-05 3.0077075362205507e-05 3.0064406394958496e-05 3.006287395954132e-05 3.0073590874671936e-05 3.0060169100761412e-05 3.0047903656959532e-05 3.0054596662521362e-05 3.0030809640884398e-05 2.6831181198358538e-05 2.6901670694351198e-05 2.979248285293579e-05 3.0019736886024474e-05 3.0023195743560792e-05 3.0096176266670227e-05 3.0048513412475586e-05 3.0062663555145263e-05 2.817697584629059e-05 3.0042163729667663e-05 3.0008772015571596e-05 2.8589912056922913e-05 3.0062018632888795e-05 3.0055601596832276e-05 3.0020986795425416e-05 3.0089752674102782e-05 3.0152073502540587e-05 3.0083494782447814e-05 3.0034419894218446e-05 3.0078717470169067e-05 3.0037055015563964e-05 3.002149224281311e-05 3.0102471709251403e-05 3.003756046295166e-05 2.9635670185089113e-05 3.006685435771942e-05 3.007059931755066e-05 2.701346606016159e-05 3.0076647996902466e-05 3.0046525597572328e-05 3.000939130783081e-05 3.00262451171875e-05 3.0138628482818605e-05 3.0040715932846068e-05 3.0033692121505736e-05 3.0070670247077943e-05 3.0007442235946657e-05 2.972369909286499e-05 3.0080094337463378e-05 3.0012451410293578e-05 3.0024046897888184e-05 2.8202073872089386e-05 3.0098134279251098e-05 2.8837186098098756e-05 3.0034308433532716e-05 2.998450756072998e-05 3.0070127844810484e-05 3.006393313407898e-05 2.632531002163887e-05 3.0030614733695983e-05 3.0052570104599e-05 2.9984306395053863e-05 3.004272520542145e-05 3.005407750606537e-05 2.873130738735199e-05 3.005708634853363e-05 3.004092574119568e-05 3.0039669871330262e-05 2.8806316554546358e-05 3.0057023167610168e-05 3.0009021759033205e-05 3.0024743676185607e-05 3.0116475224494933e-05 2.4110465645790103e-05 3.0043197870254517e-05 3.0078389048576353e-05 3.0103891491889953e-05 3.001546859741211e-05 3.0039191842079164e-05 3.0106930136680604e-05 3.006326913833618e-05 3.0095384120941163e-05 3.006874680519104e-05 3.014493405818939e-05 2.4137357622385027e-05 3.010608971118927e-05 3.0050114393234253e-05 2.4464299120008945e-05 3.0053417086601257e-05 3.0047006011009218e-05 3.001428723335266e-05 2.6824267506599428e-05 2.995145320892334e-05 3.0113600492477416e-05 2.6073895543813706e-05 3.003934144973755e-05 3.0058247447013854e-05 2.776139795780182e-05 3.0067747831344605e-05 3.007189631462097e-05 3.009383797645569e-05 3.0115686655044556e-05 3.0086130499839782e-05 3.0058462619781495e-05 3.0070711374282836e-05 3.008530259132385e-05 2.9948841631412507e-05 3.008311629295349e-05 2.7346728891134263e-05 3.01486736536026e-05 3.0024998784065246e-05 3.0049704313278197e-05 3.0087642669677734e-05 2.4732074961066247e-05 3.0088263750076294e-05 2.5846326053142547e-05 3.015408992767334e-05 2.9983619451522826e-05 3.0081290006637573e-05 3.0072532892227174e-05 3.001673638820648e-05 3.0043020248413084e-05 3.0041173696517943e-05 3.0024743676185607e-05 3.0020439624786377e-05 3.0026698112487794e-05 3.0146626234054565e-05 3.003801941871643e-05 3.008517265319824e-05 3.005179762840271e-05 2.8636312484741213e-05 3.0044023990631102e-05 2.998520612716675e-05 2.8636302947998046e-05 2.773811012506485e-05 3.0028260350227357e-05 2.5929187685251237e-05 3.0056884288787843e-05 3.0150187611579895e-05 2.837701141834259e-05 3.006447672843933e-05 3.0014913082122804e-05 3.0039821267127992e-05 3.0071123838424684e-05 3.0070404410362245e-05 3.001611351966858e-05 3.0098843574523927e-05 3.0130099058151247e-05 2.999860107898712e-05 3.0135801434516907e-05 2.7405595034360885e-05 3.00440388917923e-05 2.550517562776804e-05 3.0081161260604857e-05 3.0081200003623962e-05 3.0041520595550537e-05 2.9994399547576903e-05 3.004052400588989e-05 3.0046368837356568e-05 3.0052745342254637e-05 2.4969691298902035e-05 3.0096908807754517e-05 2.8682469129562377e-05 3.0043978691101075e-05 3.0131871104240417e-05 3.004618227481842e-05 2.8038607239723204e-05 3.0070556998252868e-05 3.003184676170349e-05 3.0065670013427736e-05 3.006266474723816e-05 3.008077383041382e-05 3.0104845762252806e-05 3.006786346435547e-05 2.7513467371463775e-05 2.9853889346122743e-05 3.0104214549064636e-05 2.4526774175465107e-05 3.0004146099090575e-05 2.9417383670806886e-05 2.9534116387367248e-05 )
set w1_array = ( 5.992629034095444e-06 5.99356092477683e-06 5.99294281064067e-06 5.9893652740865945e-06 5.99142054526601e-06 5.992181398556568e-06 5.99259453790728e-06 5.992782166809775e-06 5.992779102758505e-06 5.991894770064391e-06 5.992235028767027e-06 6.010840338654816e-06 5.991177586489357e-06 5.992272621602751e-06 5.990213247947395e-06 5.991423050523735e-06 5.990625512436964e-06 5.989886302500963e-06 5.990491103962995e-06 5.9922326352680104e-06 5.990622709156014e-06 5.992166478768923e-06 6.009074211702682e-06 5.989798795431853e-06 5.992722510942258e-06 5.991728920140304e-06 5.992989590973593e-06 5.99219078628812e-06 5.990665349760093e-06 5.991660593659617e-06 5.989953590556979e-06 5.992724545882084e-06 5.989580549299717e-06 5.9913965916493905e-06 5.993095119134523e-06 5.989788332022726e-06 5.991860879235901e-06 5.991165134706534e-06 5.991169921704568e-06 5.989897436462342e-06 5.992581797414459e-06 5.9931226397166025e-06 5.993333998718299e-06 5.990061749704182e-06 5.9928792292485014e-06 5.992685672477819e-06 5.993101815343834e-06 5.992307471693494e-06 5.993598745786585e-06 5.99072372505907e-06 5.992228979826905e-06 5.98989213258028e-06 5.992674505920149e-06 6.008368874550797e-06 5.990310418070294e-06 5.990070587955416e-06 5.9921180080855265e-06 5.993215008289553e-06 6.004017225583084e-06 5.991448075161316e-06 5.9932981427991765e-06 5.991126778186299e-06 5.989778227172792e-06 5.992882554070093e-06 5.9923919007414955e-06 5.993670895346441e-06 5.991992917493917e-06 5.992299597361125e-06 5.993328708806075e-06 5.997311479528434e-06 5.992586561129428e-06 5.991363119916059e-06 5.991413350799121e-06 5.992228681803681e-06 6.011903028935194e-06 5.992525857524015e-06 5.992973423213698e-06 5.990394046180881e-06 5.992980980896391e-06 5.9914083449402825e-06 5.989257762208581e-06 5.989476557821035e-06 5.99285655154381e-06 5.989525726996362e-06 5.99503210245166e-06 5.99043921532575e-06 5.989705947227776e-06 5.992193701327779e-06 5.992010244750418e-06 5.992401702911593e-06 5.990327098057606e-06 5.990404453710653e-06 5.989472883753478e-06 6.002496466622688e-06 6.00583760032896e-06 5.990183780901134e-06 5.993345058173873e-06 5.99327831028495e-06 5.991353499353863e-06 5.992550928727724e-06 5.992213086807169e-06 6.003082370967604e-06 5.992706380435266e-06 5.9893851950764654e-06 6.0012568110832944e-06 5.99220626486931e-06 5.992398229078389e-06 5.9931870546424765e-06 5.989914554171264e-06 5.990108041092754e-06 5.9916780140483756e-06 5.992916924529709e-06 5.991817386471666e-06 5.992684461758472e-06 5.989879853092134e-06 5.991253847838379e-06 5.992685262695886e-06 5.990421017282643e-06 5.992227848269977e-06 5.989852053113282e-06 5.998711899970658e-06 5.9919529777253045e-06 5.99240341654513e-06 5.993655002326705e-06 5.992989008896984e-06 5.9902487738290806e-06 5.9927583109820265e-06 5.992782194749452e-06 5.992064680554904e-06 5.9935668852413075e-06 5.989972277544439e-06 5.991843104944564e-06 5.989535217173398e-06 5.993085926980712e-06 6.002025548019446e-06 5.9913236038992185e-06 5.995339417946525e-06 5.992780774482526e-06 5.98962183482945e-06 5.992121053510346e-06 5.9922393081942575e-06 6.008509979234077e-06 5.9928815948078405e-06 5.992402662173845e-06 5.989281590096652e-06 5.992839228943922e-06 5.9924768327036875e-06 5.994366854079999e-06 5.992418038309552e-06 5.989685728214681e-06 5.992576302611269e-06 5.998127704602666e-06 5.992506518610753e-06 5.993545055040159e-06 5.9931977089727295e-06 5.9905846506590025e-06 6.01268005464226e-06 5.992487985291518e-06 5.991786508471705e-06 5.991180096403696e-06 5.993322287336923e-06 5.992912635789253e-06 5.990834412747063e-06 5.989714901894331e-06 5.991518040769733e-06 5.992006053798832e-06 5.9900011811405424e-06 6.014065597206354e-06 5.991182587691583e-06 5.9926014809170736e-06 6.013024783693254e-06 5.989621411077678e-06 5.99266390746925e-06 5.993401896790601e-06 6.007549087167717e-06 5.9892790475860234e-06 5.990942413569428e-06 6.002470996114426e-06 5.99280825315509e-06 5.989667208865285e-06 6.0038263673195614e-06 5.992161929258145e-06 5.9919339880580084e-06 5.9914254626492035e-06 5.99094933795277e-06 5.991731793270447e-06 5.992262409650721e-06 5.990313742891885e-06 5.991649087169208e-06 5.989593578502536e-06 5.991685399436392e-06 6.00106318097096e-06 5.9896902544423935e-06 5.993072576471604e-06 5.9925551522756e-06 5.9916093942010775e-06 6.0090406002709644e-06 5.990299223572947e-06 6.009729276061989e-06 5.98984013684094e-06 5.9894691631197925e-06 5.991879398585297e-06 5.99005560297519e-06 5.993307334952988e-06 5.992481247172691e-06 5.992782371700741e-06 5.993224521749653e-06 5.993194714770652e-06 5.992987309233285e-06 5.9900401616469025e-06 5.992856691242196e-06 5.9897935288026925e-06 5.9924719805130735e-06 5.993955134996213e-06 5.992724205949343e-06 5.989342303015292e-06 5.9973268044414e-06 6.004841611371376e-06 5.993133196257986e-06 6.008854559273459e-06 5.992282419116237e-06 5.990093163214624e-06 5.995347215444781e-06 5.991933117271401e-06 5.989653928205371e-06 5.990294646122493e-06 5.991969047696329e-06 5.989711726084352e-06 5.993315195315517e-06 5.991365871974267e-06 5.9904666939983146e-06 5.993901202105917e-06 5.9905129993567244e-06 5.997229865402914e-06 5.9927236937219276e-06 6.004100533551536e-06 5.9917747412109744e-06 5.989973837509751e-06 5.9927699432009835e-06 5.994039033190347e-06 5.992592102498748e-06 5.992764196940698e-06 5.989791717380285e-06 6.010737041011453e-06 5.991093883872963e-06 5.999387506977655e-06 5.9926778307417405e-06 5.9904903123388065e-06 5.992640195996501e-06 6.000630664289929e-06 5.990739082568325e-06 5.993041488924064e-06 5.992076787748374e-06 5.992146534495987e-06 5.990182886831463e-06 5.991214215406217e-06 5.9921169743174685e-06 5.997576575842686e-06 5.9901041062548755e-06 5.9912719946587455e-06 6.012967884540558e-06 5.993683952488936e-06 5.991874467232265e-06 5.990961957373657e-06 )
set w2_array = ( 5.204984311759472e-05 5.20444650426507e-05 5.2048561744391916e-05 5.2049739735201e-05 5.205478817038238e-05 5.2060215478762986e-05 5.205255343392491e-05 5.20416943449527e-05 5.204167901165783e-05 5.206067108362913e-05 5.2044813379645346e-05 5.433565697073937e-05 5.206482052616775e-05 5.2053424732759594e-05 5.205831112526357e-05 5.206032107770443e-05 5.2029743241146206e-05 5.2096085518598554e-05 5.202935260720551e-05 5.2053110817447305e-05 5.204543685540557e-05 5.2055862909182906e-05 5.478418838977814e-05 5.205992728844285e-05 5.2056179627776145e-05 5.206172443926334e-05 5.2041334338486196e-05 5.2052785428240894e-05 5.2056211207062e-05 5.2048648841679096e-05 5.2056497272104026e-05 5.205031150020659e-05 5.204692573659122e-05 5.2066198827698825e-05 5.204123033024371e-05 5.20366879068315e-05 5.205614520609379e-05 5.206778445467353e-05 5.2056277664378283e-05 5.20539771746844e-05 5.204206720739603e-05 5.204941592365503e-05 5.204097652249038e-05 5.204335889406502e-05 5.204153532721102e-05 5.204187143407762e-05 5.204116339050233e-05 5.205215633288026e-05 5.24892892986536e-05 5.206463921256363e-05 5.2054702168330546e-05 5.2074658438563346e-05 5.2041865801438686e-05 5.4785589247941976e-05 5.207267404161394e-05 5.2064839197322725e-05 5.205372856929898e-05 5.204106669686735e-05 5.303019046783447e-05 5.206180113181472e-05 5.204111006297171e-05 5.2051275307312605e-05 5.203898869641125e-05 5.2041499484330414e-05 5.2052751136943696e-05 5.2041124118492006e-05 5.206588059663773e-05 5.204269240424037e-05 5.204100897535681e-05 5.2685986056923865e-05 5.2042065303772685e-05 5.204802191071212e-05 5.206323415599763e-05 5.204776270501315e-05 5.434063830971718e-05 5.20493236631155e-05 5.20474519841373e-05 5.2054715076461436e-05 5.2041389621794225e-05 5.205226217955351e-05 5.2068211687728765e-05 5.2052808767184614e-05 5.2050932198762896e-05 5.204187106899917e-05 5.224317609518766e-05 5.204469857551157e-05 5.204335347004235e-05 5.20543867405504e-05 5.206140914186835e-05 5.2061425322666763e-05 5.206578802317381e-05 5.2055037036538125e-05 5.204492479376495e-05 5.301683537662029e-05 5.384998705983162e-05 5.20339389834553e-05 5.2045117503032085e-05 5.204707000777125e-05 5.205906031839549e-05 5.2050803365185856e-05 5.2054077753797175e-05 5.47940309047699e-05 5.204889779910445e-05 5.206322984024882e-05 5.481160432100296e-05 5.205227198451757e-05 5.205290068872273e-05 5.204117877595126e-05 5.204785586521029e-05 5.2070647804066535e-05 5.205583993531764e-05 5.204727310873568e-05 5.205806045979261e-05 5.204187250323593e-05 5.2045081321150064e-05 5.20644480548799e-05 5.2041869204491374e-05 5.204816045798361e-05 5.206275131367147e-05 5.204383310489357e-05 5.240187418460846e-05 5.206328156404197e-05 5.204246840253472e-05 5.204372598044574e-05 5.2041351145133375e-05 5.2061085890978576e-05 5.2049122309312224e-05 5.204169095493853e-05 5.2059543395414946e-05 5.2041000017896294e-05 5.205328849330544e-05 5.2062526347115636e-05 5.204045477323234e-05 5.204126335680485e-05 5.431556701660156e-05 5.206085417047143e-05 5.273094280809164e-05 5.204169619642198e-05 5.203875233419239e-05 5.206210318207741e-05 5.205833934061229e-05 5.432078889012337e-05 5.2041529146954415e-05 5.204996425844729e-05 5.205876386165619e-05 5.20565916839987e-05 5.205521936714649e-05 5.2460307285189626e-05 5.2057066025212404e-05 5.204354946501553e-05 5.204206772893667e-05 5.345560084283352e-05 5.206196114048362e-05 5.204106109030545e-05 5.2045837672427293e-05 5.205133193358779e-05 5.311967922747135e-05 5.2042269917204975e-05 5.20570385530591e-05 5.205903379805386e-05 5.2041038351133465e-05 5.20547000169754e-05 5.20502773784101e-05 5.204727284796536e-05 5.2069019619375466e-05 5.205431479401886e-05 5.2059180494397874e-05 5.434458366036415e-05 5.2061894526705145e-05 5.2055724687874314e-05 5.3498440191149714e-05 5.204270352609455e-05 5.205389247648418e-05 5.204109958000481e-05 5.478446313738823e-05 5.20547088701278e-05 5.2060453874990346e-05 5.268803122639656e-05 5.2049334915354845e-05 5.204438210465014e-05 5.430728933215141e-05 5.205768405087292e-05 5.205523631721735e-05 5.205749138072133e-05 5.206333533488214e-05 5.2066226651892064e-05 5.205184082686901e-05 5.204472319222987e-05 5.205905894935131e-05 5.2038607515394686e-05 5.205725638754666e-05 5.3010000690817834e-05 5.2054652074351905e-05 5.204128833860159e-05 5.205230306833982e-05 5.20608795825392e-05 5.477598705887795e-05 5.204687450826168e-05 5.432881686091423e-05 5.206273924000561e-05 5.204091089963913e-05 5.206259602494538e-05 5.204424544796347e-05 5.204108847118914e-05 5.204227390699089e-05 5.205042127147317e-05 5.204696202278137e-05 5.204116108268499e-05 5.204136616550386e-05 5.2061974726617333e-05 5.204953461326659e-05 5.204797969199717e-05 5.205177418701351e-05 5.2264072351157664e-05 5.205211853422224e-05 5.207992817647755e-05 5.304483376443386e-05 5.478597915172577e-05 5.204790916666388e-05 5.478573173284531e-05 5.205058081075549e-05 5.206773833744228e-05 5.2438031397759916e-05 5.204579036869109e-05 5.2040582498535514e-05 5.208242788165808e-05 5.205559331178665e-05 5.204487964138389e-05 5.204106472805142e-05 5.206541563011706e-05 5.206006751768291e-05 5.204149863682687e-05 5.2068734284490345e-05 5.220747680775821e-05 5.205176047049463e-05 5.270343936234712e-05 5.205988603457808e-05 5.204507770948112e-05 5.2050527926534416e-05 5.204178474098444e-05 5.20420575980097e-05 5.205852070637047e-05 5.204908126406371e-05 5.3478224337100984e-05 5.204916515387594e-05 5.3879373997449875e-05 5.2050082465633746e-05 5.206290857121348e-05 5.205130258388817e-05 5.3407953724265095e-05 5.204456334002316e-05 5.2048890797421335e-05 5.205338444374502e-05 5.205244900844991e-05 5.2044913828372956e-05 5.2066231071949e-05 5.2057689839974044e-05 5.240925888717174e-05 5.203291689418256e-05 5.206897056847811e-05 5.434355393052101e-05 5.204109469056129e-05 5.234865956753492e-05 5.204271073639393e-05 )
set i = 264
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc