circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 3.0023044943809508e-05 3.0002235174179076e-05 3.0023420453071594e-05 2.6107936203479767e-05 2.7115630358457567e-05 3.0023019313812255e-05 3.0023659467697143e-05 2.8520297408103944e-05 3.0022064447402955e-05 3.0024049878120422e-05 3.002164423465729e-05 3.0025193095207214e-05 3.0022082924842833e-05 3.0021384358406067e-05 3.0019416213035583e-05 3.0042126774787904e-05 3.002205729484558e-05 3.00295889377594e-05 3.00210577249527e-05 3.0023425221443177e-05 3.0022308826446534e-05 3.002040982246399e-05 3.0022514462471008e-05 3.001914918422699e-05 3.0022984147071838e-05 3.002349019050598e-05 3.0023565888404848e-05 3.0021044611930848e-05 3.002433717250824e-05 3.0022580623626708e-05 3.0023760199546813e-05 3.001681923866272e-05 3.001998782157898e-05 3.002290904521942e-05 3.0023099780082702e-05 3.0021406412124633e-05 3.0022884607315064e-05 3.001977205276489e-05 3.0023510456085204e-05 3.0021957755088806e-05 3.0026060342788695e-05 3.0022900104522704e-05 3.0022937655448912e-05 2.6105315536260604e-05 3.0022231340408325e-05 3.002170205116272e-05 3.002025306224823e-05 3.0021668672561646e-05 3.0020524859428404e-05 3.0022945404052734e-05 3.0027586817741395e-05 3.0021507143974303e-05 3.00240296125412e-05 )
set w1_array = ( 6.0121212285012e-06 6.009818105027079e-06 6.012405840680003e-06 5.992646863684058e-06 5.993773009628058e-06 6.012393034994602e-06 6.012413905933499e-06 6.006615379825235e-06 6.01236816868186e-06 6.012075668200851e-06 6.012332741171122e-06 6.0121185462921854e-06 6.012356089428067e-06 6.012288447469473e-06 6.01221495680511e-06 6.009608650580049e-06 6.012323502451181e-06 6.012689642608166e-06 6.012127859517932e-06 6.012430278584361e-06 6.012332946062088e-06 6.012214751914144e-06 6.0123786833137275e-06 6.01227205619216e-06 6.0123915262520315e-06 6.01240286976099e-06 6.012408690527082e-06 6.0122050195932385e-06 6.012452760711312e-06 6.012367656454444e-06 6.012235371395946e-06 6.0094086769968275e-06 6.012366222217679e-06 6.0123854633420706e-06 6.012392671778798e-06 6.01231012865901e-06 6.012389812618494e-06 6.012161796912551e-06 6.012487592175603e-06 6.012187734246254e-06 6.00941307283938e-06 6.012221522629261e-06 6.01245048828423e-06 5.991784226149321e-06 6.0123533327132466e-06 6.0122922193259e-06 6.0122067891061304e-06 6.012237215414644e-06 6.012175068259239e-06 6.0121541600674394e-06 6.013133035972715e-06 6.012235986068845e-06 6.012431545183062e-06 )
set w2_array = ( 5.199351588077843e-05 5.301599079370499e-05 5.1992121098563075e-05 5.442480975389481e-05 5.490762537717819e-05 5.199185773357749e-05 5.1992166850715874e-05 5.252463134378195e-05 5.199248817190528e-05 5.1990952000021934e-05 5.199199446849525e-05 5.199224225245416e-05 5.1991941701620814e-05 5.19921606965363e-05 5.199394551292062e-05 5.29983235001564e-05 5.199219858646393e-05 5.1989655762910844e-05 5.199300992116332e-05 5.199184951931238e-05 5.199296360835433e-05 5.1993000011891125e-05 5.199187603965402e-05 5.1992778800427915e-05 5.199195586144924e-05 5.199250672571361e-05 5.1992231678217646e-05 5.199258442223072e-05 5.199194738641381e-05 5.199190906621516e-05 5.1993472527712585e-05 5.3008958339691164e-05 5.1995003040879966e-05 5.199236122891307e-05 5.1992271471768614e-05 5.1992038186639546e-05 5.199214409850538e-05 5.1992869248613714e-05 5.1992067940533156e-05 5.199241254851222e-05 5.3005739390850065e-05 5.199494006484747e-05 5.1991892389953136e-05 5.489559614658356e-05 5.199197312444448e-05 5.1992157775908704e-05 5.199117814004421e-05 5.1992481496185065e-05 5.199342633225024e-05 5.199216798506677e-05 5.1997645961120724e-05 5.1992424009367825e-05 5.199205745756626e-05 )
set i = 53
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc