circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 3.0065417289733886e-05 3.0067458152770996e-05 3.005922019481659e-05 3.0078690648078918e-05 3.005211591720581e-05 2.826451748609543e-05 3.0056766867637634e-05 3.0067556500434874e-05 3.00607031583786e-05 3.005522608757019e-05 3.005441129207611e-05 3.0060556530952453e-05 3.0085105299949645e-05 3.006502628326416e-05 3.0083085298538208e-05 3.00814288854599e-05 3.0071757435798646e-05 3.005959689617157e-05 3.0060168504714966e-05 3.007627785205841e-05 2.5804959237575532e-05 3.0064049959182738e-05 3.0060482621192932e-05 2.9932128489017488e-05 3.0065615177154542e-05 3.0061059594154358e-05 3.0055636763572693e-05 3.005988121032715e-05 3.0071417093276977e-05 3.0062606930732727e-05 3.005980372428894e-05 2.968593567609787e-05 3.017183303833008e-05 2.9946523308753967e-05 3.006523311138153e-05 2.9347946047782897e-05 2.9983374774456024e-05 3.0062060356140138e-05 3.005636692047119e-05 2.9973566234111786e-05 3.006507694721222e-05 3.0058521628379823e-05 3.0088917016983033e-05 3.0057783126831053e-05 3.0062366724014282e-05 3.005505681037903e-05 3.0081474781036377e-05 2.8291553258895875e-05 3.0055853724479676e-05 3.007321000099182e-05 3.0064189434051513e-05 3.005762457847595e-05 2.8967535495758056e-05 2.631286680698395e-05 3.0067158341407777e-05 3.0061424374580384e-05 3.0059017539024352e-05 3.0070887804031373e-05 2.9261028170585632e-05 2.5479117035865785e-05 )
set w1_array = ( 6.011815475299955e-06 6.011965408921242e-06 6.0116426032036545e-06 6.011945115402341e-06 6.007871715351939e-06 5.994592340663075e-06 6.011513205245138e-06 6.010674549266696e-06 6.011716550216079e-06 6.011408301070333e-06 6.0113163981586695e-06 6.011704573407769e-06 6.011601159349084e-06 6.011958042159677e-06 6.01007491722703e-06 6.011740485206246e-06 6.0120933167636395e-06 6.0114783272147176e-06 6.011678319424391e-06 6.011962400749326e-06 5.9984867312014105e-06 6.011926619336009e-06 6.011754035949707e-06 6.005174418911338e-06 6.01185386441648e-06 6.011724140495062e-06 6.01145051792264e-06 6.0116685684770344e-06 6.012064846232534e-06 6.011869557201863e-06 6.011656982824207e-06 6.003423141315579e-06 5.999184068292379e-06 6.0052476022392514e-06 6.0113753322511915e-06 6.006792536005378e-06 6.005957866087556e-06 6.011764410883189e-06 6.011474685743451e-06 6.005915118381381e-06 6.011922605335713e-06 6.011603320017457e-06 6.008786283433437e-06 6.011682556942105e-06 6.011828718706966e-06 6.011385660618544e-06 6.012012533843518e-06 5.9979874026030305e-06 6.011451309546829e-06 6.011710729449988e-06 6.011893520131707e-06 6.011621303856373e-06 6.006158677861095e-06 5.99179876409471e-06 6.011766729876399e-06 6.0117422360926865e-06 6.011653043329716e-06 6.009796926751733e-06 5.998479261994362e-06 5.995513213798404e-06 )
set w2_array = ( 5.199997323192656e-05 5.199875714257359e-05 5.2003375228494404e-05 5.199916467443108e-05 5.2012890189886095e-05 5.452818474173546e-05 5.200569324195385e-05 5.200353338569403e-05 5.200099992379546e-05 5.20079564936459e-05 5.201057346723974e-05 5.200265362486243e-05 5.20007776170969e-05 5.19992589559406e-05 5.2005470439791676e-05 5.200000383332372e-05 5.1998320925980803e-05 5.200457203388214e-05 5.200343570113182e-05 5.199882603809237e-05 5.306007391214371e-05 5.199951486289501e-05 5.2001750133931634e-05 5.2018927466124296e-05 5.199961309507489e-05 5.200206128507852e-05 5.200653706863522e-05 5.200340028852224e-05 5.199843657761812e-05 5.200013359263539e-05 5.200394031777978e-05 5.504007562994957e-05 5.4012341618537905e-05 5.201777809485793e-05 5.200306368619203e-05 5.233198914676905e-05 5.201707763969898e-05 5.200174023769796e-05 5.2006693243980406e-05 5.2018726060166954e-05 5.199983068183064e-05 5.200441445037722e-05 5.201284755393863e-05 5.20022322461009e-05 5.200081759318709e-05 5.200872532278299e-05 5.199945822358131e-05 5.3975969582796094e-05 5.200710762105882e-05 5.199963533878326e-05 5.200011286139488e-05 5.2003697618842126e-05 5.230661303922534e-05 5.5602722227573395e-05 5.199907967634499e-05 5.200210188701749e-05 5.200338983163237e-05 5.2009127248078586e-05 5.3965427577495575e-05 5.5152291983366016e-05 )
set i = 60
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc