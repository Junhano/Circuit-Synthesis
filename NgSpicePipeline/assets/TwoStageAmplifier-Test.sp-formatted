circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 3.0014703869819642e-05 2.9971393048763277e-05 2.999654322862625e-05 2.9899578392505646e-05 2.8528826534748076e-05 3.0033274292945862e-05 3.0005875825881957e-05 3.0003294348716737e-05 2.4940665513277054e-05 3.0021944046020508e-05 3.0028473138809203e-05 3.001632571220398e-05 3.0026986598968507e-05 3.0207861065864563e-05 3.0010500550270082e-05 3.0012288689613342e-05 3.002375066280365e-05 2.8494255244731904e-05 2.9969422519207e-05 2.8963124752044676e-05 2.999307781457901e-05 3.0205140709877015e-05 3.0134543180465697e-05 2.7477620393037796e-05 3.002656579017639e-05 3.0013977289199828e-05 3.001528799533844e-05 2.9981373846530914e-05 2.991488367319107e-05 3.001125931739807e-05 2.998481899499893e-05 2.5396396704018118e-05 2.998699337244034e-05 2.99858558177948e-05 3.004986345767975e-05 2.9995971024036406e-05 3.005712628364563e-05 3.0017627477645873e-05 3.0035545229911803e-05 3.0014188885688782e-05 3.0119577646255492e-05 2.9872731864452364e-05 3.006527781486511e-05 3.0043985843658447e-05 3.020203411579132e-05 2.9982671439647675e-05 3.0015777945518493e-05 3.001535415649414e-05 3.0005194544792177e-05 2.942221701145172e-05 3.005664050579071e-05 2.5904851108789445e-05 3.0041850209236146e-05 )
set w1_array = ( 5.99983892776072e-06 5.99997153878212e-06 5.999835714697838e-06 5.998063119128347e-06 5.997055260464549e-06 5.999881386756897e-06 5.9998362082988025e-06 5.9989494308829304e-06 5.999666437506676e-06 5.999081743881107e-06 6.000207601115107e-06 5.999090796336532e-06 6.0002340134233235e-06 6.005160877481103e-06 5.998149238526821e-06 5.998819092288613e-06 5.9988184031099085e-06 5.998241541907191e-06 5.9980217963457104e-06 5.997491724789142e-06 5.999948991462589e-06 6.006200475618243e-06 6.0029172655195e-06 5.998267684131861e-06 5.999927496537566e-06 6.0003237463533876e-06 6.000118250027299e-06 6.000001732259989e-06 5.997850833460689e-06 6.000155605375767e-06 6.0004573818296195e-06 5.998008580878377e-06 6.000325758010149e-06 6.000407006591559e-06 6.000105351209641e-06 6.0003610085695985e-06 5.999788338318467e-06 6.000269366428256e-06 6.000096382573247e-06 6.000238977372646e-06 6.00252733938396e-06 5.995224382728339e-06 6.0008279457688334e-06 6.000062407925725e-06 6.004612198099494e-06 5.9990255478769545e-06 6.000016195699573e-06 5.999854592606425e-06 6.000342447310686e-06 6.002597821876407e-06 5.999688668176532e-06 6.000371625646949e-06 6.000213412567973e-06 )
set w2_array = ( 5.2004258327186105e-05 5.204444175586104e-05 5.2018863707780835e-05 5.511710572242737e-05 5.4625070095062255e-05 5.200778858363628e-05 5.201354311965406e-05 5.201048904284835e-05 5.5428385794162755e-05 5.2021795235574245e-05 5.202851781621575e-05 5.2022633638232945e-05 5.202943969145417e-05 5.254446673393249e-05 5.1925406493246556e-05 5.1965295610018073e-05 5.196945933625102e-05 5.2929764688014984e-05 5.192626724392175e-05 5.253070703148842e-05 5.2041147392243144e-05 5.253140766918659e-05 5.241327587142586e-05 5.463464516401291e-05 5.203752196766436e-05 5.203260426968336e-05 5.2105010604485867e-05 5.221914524957538e-05 5.1938464280217885e-05 5.204093396477401e-05 5.204014063626528e-05 5.3616969585418704e-05 5.2031288526952266e-05 5.203639829531312e-05 5.2028764374554155e-05 5.203359386697411e-05 5.2043300038203595e-05 5.20471067763865e-05 5.2046036835759875e-05 5.204472990706563e-05 5.2424556482583285e-05 5.397325673699379e-05 5.217456891015172e-05 5.2026421926915647e-05 5.25540015399456e-05 5.202280908450484e-05 5.2037507886067034e-05 5.2014795560389756e-05 5.203294583968818e-05 5.5580167889595035e-05 5.204032343626022e-05 5.505520781874657e-05 5.2031253101304174e-05 )
set i = 53
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc