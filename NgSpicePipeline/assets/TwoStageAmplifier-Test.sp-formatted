circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.9912808537483216e-05 2.9931586980819702e-05 2.9945652484893798e-05 2.9885786175727843e-05 2.990552306175232e-05 2.992129921913147e-05 2.9917224645614626e-05 2.7863542437553405e-05 2.788918077945709e-05 2.9938732385635377e-05 2.99025160074234e-05 2.693389967083931e-05 2.7349735796451568e-05 2.9944267868995668e-05 2.991358757019043e-05 2.9935405254364013e-05 2.9899702072143554e-05 2.9880485534667968e-05 2.992338240146637e-05 2.9943385124206544e-05 2.879599153995514e-05 2.9839275479316713e-05 2.9949395060539245e-05 2.993536412715912e-05 2.9925058484077453e-05 2.4815140627324583e-05 2.51356022246182e-05 2.9953439831733703e-05 2.99254447221756e-05 2.9929333925247192e-05 2.784456729888916e-05 2.991212546825409e-05 2.9921188950538637e-05 2.922283351421356e-05 2.786820948123932e-05 2.512578347697854e-05 2.9915465712547303e-05 2.991269528865814e-05 2.9916409850120543e-05 3.0011444687843322e-05 2.99364310503006e-05 2.833356559276581e-05 2.9944064021110536e-05 2.994482755661011e-05 2.5722867250442506e-05 2.9927136898040772e-05 2.990707755088806e-05 2.9054297804832457e-05 2.742602363228798e-05 2.9932475686073302e-05 2.9929378032684326e-05 2.992439568042755e-05 2.5499089919030668e-05 2.9926127195358275e-05 2.9940022230148316e-05 2.9609506130218507e-05 2.519706912338734e-05 2.994894027709961e-05 2.9935564398765564e-05 2.9942672252655028e-05 )
set w1_array = ( 6.007857359014452e-06 6.008041406981647e-06 6.0077708205208185e-06 6.008530453778803e-06 6.008317646570503e-06 6.007749688811601e-06 6.007999059744179e-06 5.9989302968606355e-06 6.006675994955003e-06 6.007180250249803e-06 6.008929227478802e-06 6.006148181855679e-06 5.994217045605183e-06 6.007183332927525e-06 6.00802596565336e-06 6.008165095932782e-06 6.008418685756624e-06 6.008193650282919e-06 6.007622255943716e-06 6.0071452138945465e-06 5.999659126624465e-06 6.007525612600148e-06 6.007700766436755e-06 6.007116771303117e-06 6.007484829984605e-06 6.007289508357644e-06 5.992699506692588e-06 6.0074930908158424e-06 6.0076200673356655e-06 6.007110168226063e-06 5.996562730520964e-06 6.008080289699137e-06 6.007716077379882e-06 6.010388195514679e-06 6.003053932450712e-06 5.9978960258886215e-06 6.007885382510721e-06 6.008016754873097e-06 6.00788779463619e-06 6.006550117395818e-06 6.007311231456697e-06 5.998755413107574e-06 6.007218415848911e-06 6.007075374014676e-06 5.9886936275288465e-06 6.007561245001852e-06 6.008111833594739e-06 6.007014297880232e-06 6.00638909637928e-06 6.007352610118687e-06 6.007495009340346e-06 6.007971827872098e-06 5.987634341232478e-06 6.007099867798388e-06 6.006997273303568e-06 5.996706512756646e-06 6.002818726934492e-06 6.006984346546233e-06 6.007329476065934e-06 6.007096691988408e-06 )
set w2_array = ( 5.200227161427028e-05 5.1999691031174734e-05 5.200088503328152e-05 5.199415018339641e-05 5.2007874825270844e-05 5.199408469093032e-05 5.1994339489610866e-05 5.302232772111893e-05 5.2341127164661883e-05 5.1997039948822926e-05 5.1996222081827e-05 5.2329729076474906e-05 5.507806923985481e-05 5.200259392638691e-05 5.201045847893692e-05 5.199649137933738e-05 5.200095930066891e-05 5.1999831116991114e-05 5.200846315571107e-05 5.2001918074907735e-05 5.3043688148260116e-05 5.199811468762345e-05 5.200055343774147e-05 5.199767116946168e-05 5.201121243112721e-05 5.2348279729485514e-05 5.354011681675911e-05 5.200703991693444e-05 5.19942950673867e-05 5.199902459350414e-05 5.508045601844788e-05 5.200684900046326e-05 5.200887587037869e-05 5.563404971361161e-05 5.263352918624878e-05 5.306513713300228e-05 5.199751417268999e-05 5.199575218674727e-05 5.199581456300803e-05 5.2153762593865395e-05 5.19964445841033e-05 5.5082981109619144e-05 5.2003320419462396e-05 5.2002904569031666e-05 5.403790816664696e-05 5.200057632033713e-05 5.200374100287445e-05 5.2399757146835325e-05 5.2333175860345365e-05 5.199628471885808e-05 5.199504240904935e-05 5.203830100595951e-05 5.5062682747840884e-05 5.200020923395641e-05 5.2001588930608706e-05 5.355448505282402e-05 5.2656703010201457e-05 5.200579449092038e-05 5.199612255883403e-05 5.19978338771034e-05 )
set i = 60
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc