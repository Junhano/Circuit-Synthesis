circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 3.0010515451431276e-05 3.0014693140983582e-05 3.0003075003623962e-05 2.9994093179702758e-05 2.9937419891357423e-05 2.9990259408950805e-05 2.9988285303115844e-05 3.0007333755493165e-05 2.6958133578300478e-05 2.461052365601063e-05 3.0005427598953246e-05 2.9404442906379698e-05 3.0006359815597534e-05 3.0006645917892456e-05 2.9487337470054628e-05 3.000302791595459e-05 2.9997987747192382e-05 3.0002620220184325e-05 3.000235915184021e-05 2.9998317956924437e-05 2.9996111392974853e-05 2.9996286630630494e-05 2.9106248021125795e-05 2.9998998641967775e-05 2.996198296546936e-05 2.999109148979187e-05 2.9998611211776734e-05 3.0000938177108765e-05 2.890154480934143e-05 2.9983198642730714e-05 2.9964586496353148e-05 3.0006912350654603e-05 3.0007179975509643e-05 3.0014121532440186e-05 2.9138598442077636e-05 3.0007665157318116e-05 3.0007258057594298e-05 3.0005592107772828e-05 2.998730421066284e-05 3.002287983894348e-05 2.951519548892975e-05 3.0007018446922303e-05 2.9997754693031312e-05 2.639927312731743e-05 2.8588592410087587e-05 2.9999070167541504e-05 2.9928589463233947e-05 2.9996581077575683e-05 2.485674903728068e-05 3.000065267086029e-05 2.9995965957641603e-05 2.9984231591224672e-05 3.0022520422935484e-05 3.0010916590690614e-05 2.9998579025268555e-05 2.9426159858703612e-05 2.9995626211166383e-05 2.472012169659138e-05 2.99994558095932e-05 2.9181327521800995e-05 )
set w1_array = ( 5.996805861592293e-06 5.9964988976716995e-06 5.997056350111962e-06 5.993131840601563e-06 5.989865180104971e-06 5.996406771242618e-06 5.995613051578402e-06 5.99707031995058e-06 5.983307756483555e-06 5.997931104153395e-06 5.997057057917118e-06 5.965861178934574e-06 5.997138520702719e-06 5.996605943888426e-06 5.990096893161535e-06 5.996779523789883e-06 5.997007623314857e-06 5.9970374815166e-06 5.996954947710037e-06 5.996977038681507e-06 5.9970007129013536e-06 5.996898788958788e-06 5.9736071564257145e-06 5.996854038909078e-06 5.996806578710675e-06 5.9960775300860404e-06 5.996911995112896e-06 5.996881429105997e-06 5.988874886184931e-06 5.995316220447421e-06 5.99240780249238e-06 5.997171731665731e-06 5.997164243832231e-06 5.99448312446475e-06 5.980086106806994e-06 5.997123247012496e-06 5.996910430490971e-06 5.997059041634202e-06 5.995886506512761e-06 5.995233239606023e-06 5.943022523075342e-06 5.997099470347166e-06 5.996570348739624e-06 5.9373340420424934e-06 5.9918238632380965e-06 5.996918849647045e-06 5.996562860906124e-06 5.997021947056055e-06 5.944036398082971e-06 5.996870439499617e-06 5.996953541412949e-06 5.996979366987944e-06 5.989902693778276e-06 5.996554646641016e-06 5.994398830458522e-06 5.9807429686188696e-06 5.9963477253913876e-06 6.007033059373498e-06 5.996773088350892e-06 5.985330533236265e-06 )
set w2_array = ( 5.199771282915026e-05 5.199260579235852e-05 5.200137594807893e-05 5.2031764602288605e-05 5.2402967073023316e-05 5.19967327369377e-05 5.199619756452739e-05 5.201680697314441e-05 5.2809865728020666e-05 5.2893110498785974e-05 5.199950627051294e-05 5.440388387441635e-05 5.200711308419704e-05 5.199551704525947e-05 5.24017237201333e-05 5.200049267336726e-05 5.2018477937206625e-05 5.200091606006026e-05 5.1999571769498285e-05 5.2020368685014545e-05 5.200906798802316e-05 5.2012657999992366e-05 5.3837980151176455e-05 5.200438216049224e-05 5.198579644039273e-05 5.199510926567018e-05 5.201115351170301e-05 5.199870363250375e-05 5.2379045099020006e-05 5.199884820356965e-05 5.2192263701930644e-05 5.20003848709166e-05 5.2001842733472584e-05 5.200702543929219e-05 5.329307626187801e-05 5.200505084730685e-05 5.200985986273736e-05 5.1998977108858525e-05 5.1995559061877426e-05 5.199726852867752e-05 5.545090425014496e-05 5.201604453939944e-05 5.199767254013568e-05 5.531878486275673e-05 5.2102529974654314e-05 5.202280040085316e-05 5.197412069048732e-05 5.201143711898476e-05 5.532846987247467e-05 5.201416147127747e-05 5.200632298272103e-05 5.199023973196745e-05 5.235455360263586e-05 5.1984822913073e-05 5.2061888867989184e-05 5.33094230145216e-05 5.1998039189726116e-05 5.2434344626963136e-05 5.1997913759201764e-05 5.2789754495024684e-05 )
set i = 60
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc