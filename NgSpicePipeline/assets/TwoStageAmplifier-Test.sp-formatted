circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.6594088822603227e-05 2.6213560849428177e-05 2.7126447930932045e-05 2.8620721474289895e-05 2.5613802671432495e-05 2.6632939726114275e-05 2.7645127195864915e-05 2.656826801598072e-05 2.5105216503143312e-05 2.5682084411382675e-05 2.864885874092579e-05 3.0105870068073274e-05 2.862813822925091e-05 2.5526360869407655e-05 2.8105214387178423e-05 2.6641605570912363e-05 2.966722384095192e-05 2.661015145480633e-05 2.915837049484253e-05 2.6599686816334725e-05 2.7058971151709557e-05 2.9766665995121003e-05 2.609910488128662e-05 2.7565252650529148e-05 2.8585940971970557e-05 2.6084682792425155e-05 2.6110291779041292e-05 2.964485555887222e-05 3.0097250342369078e-05 2.9240574091672897e-05 2.857981227338314e-05 2.8099429607391358e-05 2.6638462841510772e-05 3.010967701673508e-05 2.868336968123913e-05 2.8157961443066598e-05 2.919070541858673e-05 2.9645811170339586e-05 2.5555801689624786e-05 2.5543735027313234e-05 2.9111925065517426e-05 2.7051450163125993e-05 2.7152178585529327e-05 2.606765180826187e-05 2.508989378809929e-05 2.6100016981363297e-05 2.8088495433330536e-05 2.971252381801605e-05 2.5108369886875155e-05 2.9648604094982148e-05 3.0123238265514374e-05 2.9652759432792663e-05 2.9104585945606232e-05 2.8089189119637012e-05 2.561153620481491e-05 2.6631487756967546e-05 2.5582751482725145e-05 3.0084250867366792e-05 2.516184076666832e-05 2.6097038835287096e-05 )
set w1_array = ( 6.9577710740268226e-06 5.988615363836289e-06 8.449085935950279e-06 6.949436575174331e-06 7.447213049978018e-06 6.4746390879154205e-06 8.443824335932731e-06 7.453708279877901e-06 6.9573564492166045e-06 5.999862164258957e-06 8.44052030146122e-06 6.904488265514373e-06 7.950874701142311e-06 7.938958540558815e-06 6.943880602717399e-06 6.4693028330802916e-06 6.946853552013635e-06 6.982494819909334e-06 6.923190712928772e-06 6.967177730053663e-06 7.475056875497103e-06 5.9659308791160586e-06 6.97224585711956e-06 7.47647924721241e-06 7.4531541056931016e-06 8.435420900583267e-06 6.4807179421186445e-06 7.425105761736631e-06 7.918192654848098e-06 5.964850246906281e-06 7.4697056263685225e-06 7.961356177926063e-06 6.48121839761734e-06 7.418507844209671e-06 6.443577766418457e-06 6.465802475810051e-06 6.447424724698067e-06 7.42639733850956e-06 6.960569232702255e-06 7.4469565264880655e-06 8.472846880555152e-06 7.468355488032102e-06 6.472879335284233e-06 7.439913213253021e-06 8.400846928358078e-06 8.460572645068168e-06 7.463405955582857e-06 6.45167826116085e-06 6.969521403312683e-06 7.427970621734858e-06 7.920177489519119e-06 6.908947288990021e-06 7.441240310668945e-06 8.458395138382912e-06 6.979818366467952e-06 6.466351732611656e-06 8.438001856207848e-06 7.905836015939712e-06 6.008153095841408e-06 8.423898801207542e-06 )
set w2_array = ( 5.3965039655566214e-05 5.3907637549564246e-05 5.4518404446542265e-05 5.397944142669439e-05 5.542102456092835e-05 5.34828030988574e-05 5.5052142724394803e-05 5.347532830014825e-05 5.4398478731513026e-05 5.34204517416656e-05 5.458051446080208e-05 5.2622740805149075e-05 5.507285748422146e-05 5.296507914364338e-05 5.352032502740622e-05 5.488123698532582e-05 5.448078493773937e-05 5.209599581360817e-05 5.2585293665528295e-05 5.252336759865284e-05 5.245738217234611e-05 5.4015093553811315e-05 5.2491036772727966e-05 5.2967002741992475e-05 5.3506747264415025e-05 5.449504255503416e-05 5.344530724734068e-05 5.4528779923915866e-05 5.459953176230192e-05 5.3985553074628114e-05 5.250514851510525e-05 5.349323907494545e-05 5.3949841452762484e-05 5.407600011304021e-05 5.2559228420257565e-05 5.443073435127735e-05 5.256502576172352e-05 5.5478345945477485e-05 5.347081358358264e-05 5.3979073923081164e-05 5.201631431281567e-05 5.397560205310583e-05 5.394306593574584e-05 5.347905176132917e-05 5.5001558601856236e-05 5.199625220894813e-05 5.350028978288174e-05 5.495484118163586e-05 5.5277206704020504e-05 5.352943876758218e-05 5.254641656577587e-05 5.3115174263715744e-05 5.351042402163148e-05 5.301606719940901e-05 5.534267111122609e-05 5.302036782354117e-05 5.349460368603468e-05 5.5523959159851075e-05 5.393477771617472e-05 5.5514889359474185e-05 )
set i = 60
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc