circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.9443806707859038e-05 3.002601087093353e-05 3.004093050956726e-05 2.8080496490001678e-05 2.9921372532844542e-05 3.007242560386658e-05 3.0041223764419556e-05 3.0072894096374513e-05 3.0029976963996887e-05 3.004478931427002e-05 3.0041001439094543e-05 3.0026091933250428e-05 3.004550576210022e-05 3.0028065443038942e-05 2.991743355989456e-05 3.0029345750808717e-05 3.003621280193329e-05 2.517002087086439e-05 3.002548933029175e-05 2.8517997562885285e-05 3.002961754798889e-05 3.007270097732544e-05 3.004409968852997e-05 3.01495099067688e-05 2.5817603319883348e-05 2.9893923699855804e-05 3.002442240715027e-05 3.00293630361557e-05 3.0027790665626527e-05 3.0065202713012694e-05 2.5212499871850013e-05 2.6574037969112395e-05 3.0027236938476562e-05 2.879305988550186e-05 3.0030301213264467e-05 2.9875034987926484e-05 3.0109911561012267e-05 3.0057209730148315e-05 3.0024306774139406e-05 3.0109320282936097e-05 3.002389669418335e-05 3.002207398414612e-05 3.002852201461792e-05 3.0029274821281434e-05 3.002516210079193e-05 3.0009942054748534e-05 3.003303349018097e-05 3.0023879408836364e-05 3.004403293132782e-05 3.002746820449829e-05 3.0026535987854005e-05 2.7780395150184632e-05 3.002435028553009e-05 3.0022772550582885e-05 3.0051979422569276e-05 3.0004557967185973e-05 3.0145325660705566e-05 3.002690374851227e-05 3.0130897760391236e-05 2.9444409012794494e-05 3.0029724836349487e-05 3.0026424527168275e-05 3.0025657415390014e-05 3.0027116537094115e-05 3.0072503685951233e-05 3.0046296119689943e-05 3.0025330185890197e-05 3.002614140510559e-05 3.005203902721405e-05 3.0064833164215088e-05 2.9961588680744173e-05 3.0029454231262206e-05 2.9406132102012634e-05 3.0026620030403136e-05 3.0036141872406006e-05 2.673695206642151e-05 3.007211983203888e-05 3.0030112862586974e-05 3.00582093000412e-05 2.7525329291820528e-05 3.0062698125839234e-05 3.0029340386390688e-05 3.0025995969772338e-05 3.0025503039360046e-05 2.9959109127521515e-05 2.813569873571396e-05 2.7562072575092317e-05 3.0051938891410826e-05 3.0036640167236328e-05 3.003302037715912e-05 3.0022989511489868e-05 3.0028406977653503e-05 2.5338507369160652e-05 3.0024755597114563e-05 3.0024834275245668e-05 3.0050660371780396e-05 3.003891408443451e-05 3.0031687617301942e-05 3.0029385089874268e-05 2.647834926843643e-05 3.0030452609062194e-05 3.002375304698944e-05 3.0024921894073486e-05 3.0025583505630493e-05 3.0028802156448363e-05 3.002820611000061e-05 3.0051401257514954e-05 3.003059506416321e-05 3.0072885155677795e-05 3.0066250562667846e-05 3.0028455853462218e-05 3.0084761977195738e-05 2.768858015537262e-05 2.8425523936748506e-05 3.0026673078536988e-05 2.9657035171985625e-05 2.9931080043315887e-05 3.0019134879112245e-05 2.9892129004001618e-05 2.984182983636856e-05 2.911756366491318e-05 3.0035068988800048e-05 2.960941821336746e-05 3.004590153694153e-05 3.0032761693000793e-05 2.9187953770160676e-05 3.003239393234253e-05 2.547404818236828e-05 3.002757489681244e-05 2.7038879096508026e-05 3.0028159618377687e-05 3.0070592761039734e-05 3.004950523376465e-05 2.842175304889679e-05 3.0028049349784853e-05 2.987859010696411e-05 3.0028231739997862e-05 3.002966105937958e-05 3.0022276043891905e-05 3.0022121667861937e-05 2.8229299485683442e-05 3.0029166340827942e-05 2.980076342821121e-05 3.0027738213539125e-05 2.8853064179420472e-05 2.9865733385086058e-05 3.0027634501457213e-05 3.0026254057884217e-05 3.0026609301567076e-05 3.006508767604828e-05 3.0023268461227417e-05 2.882106125354767e-05 3.0031819343566895e-05 3.002769947052002e-05 3.0021817684173585e-05 2.9960582852363586e-05 2.9381155669689177e-05 3.002403676509857e-05 3.0071967244148254e-05 3.005756139755249e-05 3.0058180093765258e-05 3.001042425632477e-05 3.002922475337982e-05 3.0024537444114687e-05 3.002655029296875e-05 3.0027880072593688e-05 3.003329932689667e-05 3.0072901248931884e-05 3.0036668777465822e-05 3.0046239495277404e-05 3.0024734735488893e-05 3.016511619091034e-05 3.002716362476349e-05 3.0111399888992308e-05 3.003548204898834e-05 3.0055691003799437e-05 3.002709627151489e-05 2.8534733057022095e-05 3.0027193427085878e-05 3.0027638673782347e-05 3.0041593313217163e-05 3.0026432275772096e-05 2.5520173683762552e-05 3.0024879574775694e-05 3.0030215978622436e-05 3.0041419863700867e-05 3.002748489379883e-05 3.0041306018829345e-05 3.0021374821662904e-05 3.0037930607795716e-05 3.0027901530265807e-05 3.0030748844146728e-05 3.002735137939453e-05 2.9993438124656677e-05 3.0029292702674866e-05 2.991889774799347e-05 3.0033541917800902e-05 3.003288686275482e-05 3.0024991631507874e-05 3.00236177444458e-05 3.004185199737549e-05 2.99914088845253e-05 3.0057069063186644e-05 3.0029726028442383e-05 3.0027085542678832e-05 2.9184497594833373e-05 3.0030723214149475e-05 3.0064987540245056e-05 2.9976234436035155e-05 3.0090731382369996e-05 2.700062096118927e-05 2.980948746204376e-05 3.0027714371681214e-05 3.0056076049804686e-05 2.879741758108139e-05 3.00381600856781e-05 3.002396881580353e-05 3.0050264000892638e-05 3.0036996603012086e-05 3.0029041171073915e-05 3.0021923184394835e-05 3.0025794506072997e-05 3.0025970935821534e-05 3.0026307106018066e-05 2.9945879876613618e-05 3.006517171859741e-05 2.7645299434661867e-05 2.5233094282448294e-05 3.006350040435791e-05 2.9627107679843902e-05 3.0039932131767272e-05 3.0026957392692567e-05 3.0024864077568055e-05 3.0032618045806885e-05 3.002901077270508e-05 3.002692222595215e-05 3.0052531361579895e-05 3.002481520175934e-05 2.6558654606342316e-05 3.0072730779647827e-05 2.9987834393978118e-05 3.0024925470352174e-05 3.0012706518173216e-05 3.0025448203086852e-05 3.0022509694099425e-05 3.002874255180359e-05 3.0037210583686828e-05 3.0028176307678222e-05 3.0029755234718324e-05 3.0031077861785888e-05 2.999284118413925e-05 3.0036919116973877e-05 2.9972796142101288e-05 3.002417743206024e-05 3.010602951049805e-05 3.0025230646133423e-05 3.0045416355133057e-05 3.002452492713928e-05 2.7133030593395234e-05 3.0038774609565736e-05 3.0071355700492858e-05 3.003025412559509e-05 3.0027244091033934e-05 2.755967438220978e-05 )
set w1_array = ( 6.022180117666721e-06 6.010362649336457e-06 6.009813159704208e-06 6.002543423324824e-06 6.00776618719101e-06 6.009323013946414e-06 6.009671049192548e-06 6.009617367759347e-06 6.0103405863046645e-06 6.009894566610456e-06 6.009896624833345e-06 6.009713601320982e-06 6.009422749280929e-06 6.010285582393408e-06 6.008217273280025e-06 6.010142475366593e-06 6.010003102943301e-06 6.00007288530469e-06 6.010689236223697e-06 6.021399334073067e-06 6.010645110160112e-06 6.010486952960491e-06 6.009309649467468e-06 6.012827022001147e-06 6.002178326249123e-06 6.007216148078442e-06 6.010629892349243e-06 6.0100438483059405e-06 6.010455399751663e-06 6.0095930136740205e-06 6.016201687976718e-06 6.019432026892901e-06 6.010484419763088e-06 6.02149673178792e-06 6.009505152702332e-06 6.007099397480488e-06 6.011492241173982e-06 6.0131842121481895e-06 6.010865367949009e-06 6.0131850875914095e-06 6.0100521184504034e-06 6.0103112775832415e-06 6.009571649134159e-06 6.0105956569314e-06 6.010119257494807e-06 6.011940356343985e-06 6.009257923811674e-06 6.0096333585679535e-06 6.009912541136146e-06 6.0098125636577605e-06 6.010180836543441e-06 6.017245542258024e-06 6.010748477652669e-06 6.010298900306225e-06 6.009693130850792e-06 6.0093759689480066e-06 6.01189598813653e-06 6.009931474924088e-06 6.0130536593496796e-06 6.01342412084341e-06 6.010135816410184e-06 6.010271044448018e-06 6.0104524288326504e-06 6.010714661329985e-06 6.009768363088369e-06 6.0096048042178155e-06 6.010378938168287e-06 6.009545590728521e-06 6.009628599509597e-06 6.0097301695495845e-06 6.010609263554215e-06 6.009514279663563e-06 6.019537247717381e-06 6.01009227707982e-06 6.0097310449928046e-06 6.018253717571497e-06 6.009832959622145e-06 6.0102252420037985e-06 6.009520575404167e-06 6.010356875136495e-06 6.008931905031204e-06 6.010483162477612e-06 6.011000419035554e-06 6.009977910667658e-06 6.008645290508866e-06 5.9973001331090925e-06 6.004282006993889e-06 6.0095534324646e-06 6.009973235428333e-06 6.009972099214792e-06 6.010216115042567e-06 6.010181656107306e-06 5.980938285589218e-06 6.009989263489842e-06 6.010073082521558e-06 6.0092585943639274e-06 6.009193010628224e-06 6.0100077595561745e-06 6.009133778512478e-06 5.996858416125178e-06 6.009637484326959e-06 6.009561972692609e-06 6.010718908160925e-06 6.0102436542510985e-06 6.0105122569948435e-06 6.010654833167791e-06 6.00979358330369e-06 6.009178165346384e-06 6.009529031813145e-06 6.012258840724826e-06 6.010309796780348e-06 6.013226605951786e-06 5.992243740707636e-06 6.0160855613648894e-06 6.01010749489069e-06 6.015837540850044e-06 6.008884202688933e-06 6.009766761213541e-06 6.0097969360649585e-06 6.008233720436692e-06 6.020575597882271e-06 6.009714681655169e-06 6.022654701024294e-06 6.009835474193097e-06 6.010062232613563e-06 6.010266322642565e-06 6.009462824091315e-06 5.972274526953697e-06 6.010121241211891e-06 6.017902525141835e-06 6.010106582194567e-06 6.008928366005421e-06 6.009883809834719e-06 6.019742287695408e-06 6.010312078520656e-06 6.008755838498473e-06 6.010098516941071e-06 6.0102930050343275e-06 6.0101667456328865e-06 6.009876964613795e-06 6.017396323382854e-06 6.010163569822908e-06 6.005307085812092e-06 6.010440275073051e-06 6.010622069239616e-06 6.007864348590374e-06 6.010907500982285e-06 6.00996601767838e-06 6.0106299296021465e-06 6.009665954858065e-06 6.009717354550958e-06 6.014776205644011e-06 6.009653670713305e-06 6.01019760966301e-06 6.010592956095934e-06 6.009320415556431e-06 6.023568887263536e-06 6.009711030870676e-06 6.009203739464283e-06 6.009775515645742e-06 6.009666578844189e-06 6.009360294789076e-06 6.0097915902733805e-06 6.009557344019413e-06 6.010969322174788e-06 6.009951097890735e-06 6.0098624918609855e-06 6.010928399860859e-06 6.0097491964697835e-06 6.009792912751436e-06 6.010248254984617e-06 6.0125022977590565e-06 6.0106003787368534e-06 6.012258058413863e-06 6.009326506406069e-06 6.009911870583892e-06 6.010827332735062e-06 6.0020830985158685e-06 6.009678676724434e-06 6.010796906426549e-06 6.009457236155868e-06 6.010476624593138e-06 6.021706968545914e-06 6.010258220136166e-06 6.010150261223316e-06 6.009743832051754e-06 6.010247230529785e-06 6.009856028482318e-06 6.010322984308004e-06 6.009385142475367e-06 6.010338183492422e-06 6.009996592998505e-06 6.010078195482492e-06 6.012876428663731e-06 6.009914133697748e-06 6.012326594442129e-06 6.010024905204773e-06 6.009910389780998e-06 6.0106008164584635e-06 6.009861933067441e-06 6.009722821414471e-06 6.009064069017768e-06 6.009219544008374e-06 6.010785842314363e-06 6.010458584874868e-06 6.022345166653395e-06 6.009628813713789e-06 6.009418269619346e-06 6.010064579546451e-06 6.0109456945210695e-06 6.007434440776705e-06 6.0058462098240855e-06 6.010570883750916e-06 6.01011204905808e-06 6.018564816564322e-06 6.009584287181497e-06 6.01041023992002e-06 6.00986073166132e-06 6.0098833907395605e-06 6.00978920608759e-06 6.010453332215548e-06 6.010331310331821e-06 6.0102082639932635e-06 6.009503364562989e-06 6.009678564965725e-06 6.009510731324553e-06 6.019965404644608e-06 5.990427847951651e-06 6.009072255343199e-06 6.0208623614162205e-06 6.00995023176074e-06 6.009538671001792e-06 6.010949801653623e-06 6.010017128661275e-06 6.010281456634403e-06 6.010275272652507e-06 6.010826662182808e-06 6.009703934192657e-06 5.9890828505158424e-06 6.009431196376681e-06 6.0096977408975365e-06 6.009884629398585e-06 6.010008662939072e-06 6.0108050182461735e-06 6.0097228307276964e-06 6.010625179857016e-06 6.009745713323354e-06 6.010766601189971e-06 6.010676793754101e-06 6.010156370699406e-06 6.010937228798867e-06 6.00982204452157e-06 6.009120320901275e-06 6.01027231104672e-06 6.010875090956688e-06 6.01035925000906e-06 6.009869039058686e-06 6.010509472340345e-06 6.019514271989464e-06 6.009979195892811e-06 6.009072441607714e-06 6.009812600910663e-06 6.00958101823926e-06 6.019124774262309e-06 )
set w2_array = ( 5.4654071509838106e-05 5.202450409159064e-05 5.202994189597666e-05 5.268098489940166e-05 5.201395408064127e-05 5.203346508555114e-05 5.202393698133528e-05 5.203253718651831e-05 5.2027907522395254e-05 5.202238976582885e-05 5.202196103334427e-05 5.202484710887074e-05 5.202604040689766e-05 5.2022478766739366e-05 5.202748038060963e-05 5.202303956635296e-05 5.2020621990785e-05 5.342082680761814e-05 5.202697287593037e-05 5.470507609844208e-05 5.2055482080206276e-05 5.2047501660883426e-05 5.202801555301994e-05 5.213370554894209e-05 5.3406395047903064e-05 5.201215485669672e-05 5.202748946845531e-05 5.2029568890109655e-05 5.202764646522701e-05 5.202971631661057e-05 5.431704318523407e-05 5.480398190021515e-05 5.2027597974985834e-05 5.369019702076912e-05 5.202801954280585e-05 5.201742677204311e-05 5.207804078608751e-05 5.213025609217584e-05 5.202645002491772e-05 5.21301538310945e-05 5.202359659783542e-05 5.2024836775846776e-05 5.202547634765506e-05 5.202681531198323e-05 5.2025380729697644e-05 5.209762294217944e-05 5.20271437978372e-05 5.2027839031070466e-05 5.202208131365478e-05 5.2026566843502224e-05 5.2029351864010096e-05 5.532554966211319e-05 5.202695121895522e-05 5.2024841098114844e-05 5.202535145822912e-05 5.202583854459226e-05 5.210448333993554e-05 5.202397622726858e-05 5.2131439194083214e-05 5.24369997382164e-05 5.2028995638713236e-05 5.20226504188031e-05 5.202807175554335e-05 5.202658424992114e-05 5.2032261252403255e-05 5.202494081668556e-05 5.2024472355842586e-05 5.2027770187705755e-05 5.202577723748982e-05 5.202921106107533e-05 5.2072709480300544e-05 5.2027950027957556e-05 5.291348072886467e-05 5.2025452428497374e-05 5.202504131756723e-05 5.537092870473862e-05 5.203222705237567e-05 5.2028470695018766e-05 5.202791553456336e-05 5.3346597701311114e-05 5.203262184560299e-05 5.202730778977275e-05 5.202561570331454e-05 5.202590892650187e-05 5.202213425002992e-05 5.245403111726046e-05 5.298909619450569e-05 5.202624230831861e-05 5.202109440229833e-05 5.202150223404169e-05 5.2023066647350785e-05 5.202509782649576e-05 5.273347306251526e-05 5.20258814021945e-05 5.2023485952988265e-05 5.2027869241312144e-05 5.202800895553082e-05 5.202360069192946e-05 5.202750353701412e-05 5.302359527349472e-05 5.2027393791824577e-05 5.202775733172893e-05 5.202695682551712e-05 5.20249241925776e-05 5.202724063489586e-05 5.2026688740588724e-05 5.202461414318532e-05 5.202736415527761e-05 5.203277828171849e-05 5.2097301145084204e-05 5.202826237864792e-05 5.21297751404345e-05 5.2459888018667694e-05 5.33011400103569e-05 5.2023285681381823e-05 5.243839282542467e-05 5.2038646350614726e-05 5.203358584828675e-05 5.207460587378591e-05 5.205419596750289e-05 5.3264101132750513e-05 5.20250674597919e-05 5.325008952617645e-05 5.202311159111559e-05 5.2020456245169046e-05 5.24387576431036e-05 5.2026124459691345e-05 5.24733816832304e-05 5.202319611981511e-05 5.42597029209137e-05 5.201771440170705e-05 5.203503423836082e-05 5.202381279598921e-05 5.371285191178322e-05 5.2024627631530165e-05 5.2053519522771236e-05 5.2029452560469506e-05 5.202233470417559e-05 5.20253205569461e-05 5.202643934637308e-05 5.530047941207886e-05 5.202892525028437e-05 5.2007365809753533e-05 5.2024190182797606e-05 5.265722924470901e-05 5.2037604605779054e-05 5.202574389800429e-05 5.202594408486038e-05 5.202703224029392e-05 5.2029434964992104e-05 5.202706095110625e-05 5.2935629934072496e-05 5.202521767653525e-05 5.202504668291658e-05 5.202398337237537e-05 5.20395490527153e-05 5.366016410291195e-05 5.20270565636456e-05 5.203391296509653e-05 5.2026554874144495e-05 5.202714105322957e-05 5.202187027223408e-05 5.202454886585474e-05 5.20277482047677e-05 5.202565275877714e-05 5.2023883666843176e-05 5.202429544925689e-05 5.20585427088663e-05 5.2023171529173847e-05 5.2023522187024354e-05 5.202284714393317e-05 5.213702794536948e-05 5.2027074009180066e-05 5.209948917105794e-05 5.2026994317770006e-05 5.2032147400081154e-05 5.2026125626638533e-05 5.2448087535798546e-05 5.202715126890689e-05 5.202617453411221e-05 5.2026904247701164e-05 5.2024113490246235e-05 5.5403061866760255e-05 5.202489438001066e-05 5.202297295257449e-05 5.202340704388916e-05 5.2028761473484335e-05 5.2022418672218914e-05 5.202483985945582e-05 5.2026910877786575e-05 5.202820699103177e-05 5.202365802228451e-05 5.202549756783992e-05 5.213373658061027e-05 5.20261531509459e-05 5.214061254635453e-05 5.2023513829335566e-05 5.202204308472573e-05 5.2027490459382534e-05 5.202642628829926e-05 5.202619021292776e-05 5.201979842595756e-05 5.2029431405477225e-05 5.202598398923874e-05 5.2024149789474907e-05 5.466426283121109e-05 5.2025291761383415e-05 5.203044794686138e-05 5.205369877628982e-05 5.206058328226208e-05 5.33687085211277e-05 5.201498455367982e-05 5.202712319698185e-05 5.2037574428133664e-05 5.328070667386055e-05 5.202591430488974e-05 5.2024423852562906e-05 5.202403799071908e-05 5.2022096255794165e-05 5.202668020687997e-05 5.202439242973923e-05 5.202868348360061e-05 5.2029341713525354e-05 5.2025712996721265e-05 5.2053290664218366e-05 5.20300540337339e-05 5.475677162408829e-05 5.3049750745296475e-05 5.203198309522122e-05 5.2911052852869036e-05 5.202112559042871e-05 5.2027799289673566e-05 5.2025995776057244e-05 5.202355255372822e-05 5.20283253416419e-05 5.2028724783100186e-05 5.205684891436249e-05 5.2027064328081905e-05 5.2716835394501684e-05 5.2033087242394686e-05 5.2040688332170244e-05 5.202418694272637e-05 5.2042052610777315e-05 5.202647872269153e-05 5.202707842271775e-05 5.202674937620759e-05 5.202502704039216e-05 5.202622916549444e-05 5.2026421457529066e-05 5.202291455306113e-05 5.207246942818165e-05 5.202262560650706e-05 5.203021459002048e-05 5.202487043477595e-05 5.2062997422181066e-05 5.202868082374334e-05 5.202273409999907e-05 5.202806843072176e-05 5.478165119886399e-05 5.203549928963184e-05 5.203443440794945e-05 5.202447018492967e-05 5.202400154806674e-05 5.4234578847885134e-05 )
set i = 264
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc