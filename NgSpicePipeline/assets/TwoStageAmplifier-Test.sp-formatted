circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.9744666814804076e-05 2.995113968849182e-05 2.6956030577421187e-05 3.0040321946144105e-05 2.9933957159519195e-05 2.993829131126404e-05 2.997070848941803e-05 2.9941096901893617e-05 2.929746448993683e-05 2.9967538118362427e-05 2.9985780715942383e-05 2.9968976974487304e-05 3.0029165148735046e-05 2.9968777298927306e-05 2.995517075061798e-05 2.9945042431354524e-05 2.9967061579227448e-05 2.96433299779892e-05 2.9943102598190307e-05 2.9974132776260376e-05 2.997531235218048e-05 2.992608368396759e-05 2.994378864765167e-05 2.993358612060547e-05 2.9970524609088896e-05 2.9950878024101257e-05 2.9989625215530396e-05 2.9991692900657655e-05 2.9955855906009675e-05 2.995909512042999e-05 2.9935838878154753e-05 2.998873233795166e-05 3.0010685920715333e-05 2.996928781270981e-05 2.9931285381317138e-05 2.997761070728302e-05 2.9991934299468993e-05 2.9980513751506805e-05 2.9960069358348845e-05 2.997358500957489e-05 2.9925963282585143e-05 2.995183229446411e-05 3.0035882592201234e-05 2.9927505850791932e-05 3.001560866832733e-05 2.9933065474033357e-05 2.997880458831787e-05 2.9948480129241942e-05 2.994772493839264e-05 2.9948325753211974e-05 2.6313836127519608e-05 2.9991422295570374e-05 2.993820369243622e-05 )
set w1_array = ( 5.997891634702682e-06 6.010612374171615e-06 6.006803181022406e-06 6.011873990297318e-06 6.01082289032638e-06 6.010565323755145e-06 6.0105096120387314e-06 6.010588774457574e-06 6.008580600842834e-06 6.010808883234859e-06 6.010061347857118e-06 6.010727746412158e-06 6.011939974501729e-06 6.010462505742907e-06 6.010455166921019e-06 6.010709650814533e-06 6.010397406294942e-06 6.003107357770204e-06 6.011007403954863e-06 6.010374039411545e-06 6.0102432165294885e-06 6.010950099676847e-06 6.010860292240977e-06 6.010966006666422e-06 6.01047427766025e-06 6.011047730222344e-06 6.010056961327791e-06 6.010751225054264e-06 6.011497577652336e-06 6.010657338425517e-06 6.01163967885077e-06 6.010070344433188e-06 6.011509098112583e-06 6.010720901191235e-06 6.01066155731678e-06 6.009545898064971e-06 6.01130879856646e-06 6.010174410417676e-06 6.0108353607356545e-06 6.0105606950819495e-06 6.010650893673301e-06 6.010533081367612e-06 6.011939089745283e-06 6.010802121832967e-06 6.011205049231648e-06 6.010669333860278e-06 6.0102056190371515e-06 6.01057954505086e-06 6.010407539084554e-06 6.009805038571358e-06 5.9981447588652375e-06 6.010026628151536e-06 6.010845279321074e-06 )
set w2_array = ( 5.5043424963951115e-05 5.2025152783840894e-05 5.5624132931232456e-05 5.241038218140602e-05 5.201619730517268e-05 5.201848988048732e-05 5.202502212487161e-05 5.201784920692444e-05 5.3336048290133474e-05 5.2016662245616314e-05 5.2023599283769724e-05 5.201591096632182e-05 5.26552739366889e-05 5.202404876053333e-05 5.2020909033715726e-05 5.201513634808362e-05 5.2021476261317726e-05 5.453329646587372e-05 5.202683595195412e-05 5.201980049908161e-05 5.202389840036631e-05 5.202326282486319e-05 5.2017598293721674e-05 5.202374568022787e-05 5.2023563884198666e-05 5.2021379385143515e-05 5.202395720407367e-05 5.2009141460061075e-05 5.2364673264324664e-05 5.202613427117467e-05 5.2657015830278394e-05 5.2024173669517036e-05 5.211873778887093e-05 5.201588767953217e-05 5.201622029207647e-05 5.201289663091302e-05 5.2046635851264e-05 5.202381421066821e-05 5.2024434791877864e-05 5.2024275291711094e-05 5.201638223044574e-05 5.202588161081075e-05 5.267490540444851e-05 5.2016146585345267e-05 5.20176952611655e-05 5.201609951630235e-05 5.202243052423e-05 5.2016645282506944e-05 5.202298283576965e-05 5.200117170624435e-05 5.378640103340149e-05 5.202344426885247e-05 5.201647239178419e-05 )
set i = 53
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc