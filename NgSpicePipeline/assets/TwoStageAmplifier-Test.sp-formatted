circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.4980316162109376e-05 2.591079130768776e-05 2.648992009460926e-05 2.9785224348306656e-05 2.502189785242081e-05 2.55307537317276e-05 2.7943344712257386e-05 2.9366202056407928e-05 2.6927683800458908e-05 2.6388709768652918e-05 2.6415826827287674e-05 2.8458671793341636e-05 2.5986904501914978e-05 2.9903046041727066e-05 )
set w1_array = ( 5.981794357299805e-06 5.986722618341446e-06 6.9881708212196824e-06 8.438061088323593e-06 5.994747489690781e-06 6.990745089948177e-06 7.510037910193205e-06 6.4799880087375644e-06 8.485421746969223e-06 7.489109732210636e-06 7.499694604426622e-06 6.502557754516601e-06 7.486412398517132e-06 5.984553456306457e-06 )
set w2_array = ( 5.4115849234163764e-05 5.2613557517528535e-05 5.459161853045225e-05 5.5141272455453875e-05 5.227699482440948e-05 5.541159906983376e-05 5.302854490280151e-05 5.537383817136288e-05 5.465262684226036e-05 5.215203306078911e-05 5.248753181099892e-05 5.456413354724646e-05 5.551534059643746e-05 5.3070999927818773e-05 )
set i = 14
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc