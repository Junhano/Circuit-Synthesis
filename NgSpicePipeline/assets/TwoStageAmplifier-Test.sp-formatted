circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.5095006525516512e-05 2.5477578043937684e-05 2.934467911720276e-05 2.740679731592536e-05 2.9982801973819732e-05 2.7304595392197372e-05 2.7388479094952346e-05 2.6009386777877807e-05 2.6454036012291908e-05 2.842521905899048e-05 2.9860531389713287e-05 2.8409423530101776e-05 2.7361083533614875e-05 2.5501670241355897e-05 )
set w1_array = ( 6.990236289799213e-06 6.467537119984627e-06 8.466736733913422e-06 6.981710832566023e-06 5.960281699895859e-06 8.473011314868926e-06 7.477967295795679e-06 5.9687279760837554e-06 7.968038082122802e-06 5.977913498878479e-06 7.988510191440582e-06 6.480883121490479e-06 5.974036067724228e-06 6.95639830455184e-06 )
set w2_array = ( 5.246115218102932e-05 5.2928122773766514e-05 5.55339744091034e-05 5.245892687141895e-05 5.236779974400997e-05 5.45236486941576e-05 5.2520415887236594e-05 5.408880234509707e-05 5.3428547356277704e-05 5.2340018108487126e-05 5.218390868604183e-05 5.272088651359081e-05 5.224237109720707e-05 5.501222890615463e-05 )
set i = 14
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc