circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.7775518894195557e-05 3.0001556873321533e-05 2.996973931789398e-05 2.99442458152771e-05 2.996929407119751e-05 2.998028039932251e-05 3.0005255937576293e-05 2.998123288154602e-05 2.839747190475464e-05 2.996885061264038e-05 2.99696284532547e-05 2.9963263273239134e-05 2.9128438532352446e-05 2.996673822402954e-05 2.9978966116905213e-05 2.9838229715824126e-05 2.9957626461982727e-05 2.9990801811218263e-05 2.9975068569183348e-05 2.9968091249465942e-05 2.9967546463012695e-05 2.8304007947444916e-05 2.9965392351150513e-05 2.997174918651581e-05 2.994444638490677e-05 2.9954874515533446e-05 2.9962854981422424e-05 2.996869444847107e-05 2.5131698390468954e-05 2.9937328696250917e-05 2.8276428878307344e-05 2.7287758141756058e-05 2.994959056377411e-05 2.9978047609329222e-05 2.9959102869033813e-05 2.9978898763656617e-05 2.991356134414673e-05 2.996873736381531e-05 2.502540328539908e-05 2.9974224567413332e-05 2.9975364804267883e-05 2.996618390083313e-05 2.9950298368930816e-05 2.990605354309082e-05 2.9988474249839783e-05 2.9848619401454924e-05 2.995471239089966e-05 2.9975772500038147e-05 2.9968326091766357e-05 2.9896835386753083e-05 2.4653603769838812e-05 2.9973814487457276e-05 2.978077232837677e-05 )
set w1_array = ( 6.027146353386343e-06 6.022259429097176e-06 6.017699543386697e-06 6.026065297424793e-06 6.017575360834599e-06 6.021448768675327e-06 6.025245314463973e-06 6.019792765378952e-06 6.030378764495254e-06 6.017640870064497e-06 6.019037742167711e-06 6.019619064405561e-06 6.0320516480132935e-06 6.0165495369583365e-06 6.019800504669547e-06 6.0206054095178845e-06 6.019985903054475e-06 6.020697265863418e-06 6.019102022051811e-06 6.020643221214413e-06 6.020478814840317e-06 6.017991978675127e-06 6.018184408545494e-06 6.021078959107399e-06 6.017121564596892e-06 6.019337385892868e-06 6.0190260540694e-06 6.0215797126293186e-06 6.001387982629239e-06 6.0156859681010245e-06 6.031352727673948e-06 6.028159853536635e-06 6.018435874953866e-06 6.019267275929451e-06 6.019502053037286e-06 6.018837675452232e-06 6.018647909164429e-06 6.0200101640075445e-06 6.014282232150436e-06 6.018692603334785e-06 6.021646767854691e-06 6.019800700247288e-06 6.02201403491199e-06 6.018777456134557e-06 6.019841799512506e-06 6.019178437069058e-06 6.016231574118137e-06 6.018342193216085e-06 6.018235445022583e-06 6.018907580524683e-06 6.016240049153566e-06 6.017995601519942e-06 6.025637107901275e-06 )
set w2_array = ( 5.383106660842896e-05 5.2060520410537715e-05 5.199882967257872e-05 5.202629295317456e-05 5.199642464006319e-05 5.197958976449445e-05 5.2196868058294055e-05 5.1975281415041535e-05 5.524573516845703e-05 5.1999571081716565e-05 5.198311403626576e-05 5.197526644682512e-05 5.4848925143480304e-05 5.199820703780278e-05 5.197625860618427e-05 5.218429707735777e-05 5.197745376219973e-05 5.197088205674663e-05 5.198080507153645e-05 5.1970822138246145e-05 5.205084826657548e-05 5.237841014936566e-05 5.1992234765086324e-05 5.19884861591272e-05 5.199877158598974e-05 5.198101920960471e-05 5.1985043990891426e-05 5.19688366134651e-05 5.232301061600447e-05 5.200756447436288e-05 5.43466312289238e-05 5.4327533662319186e-05 5.198761696601287e-05 5.198163630953058e-05 5.1975984621327366e-05 5.198532163957134e-05 5.196112966397777e-05 5.197263239277527e-05 5.433645659685135e-05 5.198914320254698e-05 5.197750589670613e-05 5.197251458326354e-05 5.196937844203785e-05 5.1980358195956796e-05 5.1966840925160794e-05 5.205576565489173e-05 5.200754975387826e-05 5.199145227810368e-05 5.198500951053575e-05 5.195738134486601e-05 5.526547214388847e-05 5.199482034193352e-05 5.2623269021511076e-05 )
set i = 53
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc