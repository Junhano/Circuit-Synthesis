circuit: TwoStageAmplifier
.include NgSpicePipeline/assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.6017966642975806e-05 2.7020832896232607e-05 2.9979466497898103e-05 2.500970982015133e-05 2.9035217761993407e-05 2.550275534391403e-05 2.8022319078445435e-05 2.753070592880249e-05 2.647895961999893e-05 2.5503608882427218e-05 2.754316508769989e-05 2.7539182305336e-05 2.7006475627422333e-05 2.9018477499485016e-05 2.749415084719658e-05 2.5022931471467018e-05 2.7535205483436584e-05 2.6038987189531327e-05 2.5482157170772553e-05 2.8049642741680146e-05 2.8561325669288635e-05 2.9057001173496247e-05 2.9995973408222198e-05 2.6506664156913758e-05 2.7033766806125642e-05 2.8553474545478822e-05 2.948538988828659e-05 2.6517191231250765e-05 2.6540718376636504e-05 2.9041020572185518e-05 2.8050580024719238e-05 2.9512327015399932e-05 2.5066126883029938e-05 2.6515092700719835e-05 2.9491175413131716e-05 2.901558429002762e-05 2.9035539627075194e-05 2.9015879333019257e-05 2.6020365208387374e-05 2.8533079624176026e-05 2.7004331797361373e-05 2.502124771475792e-05 2.6498508453369143e-05 2.600328266620636e-05 2.9000405967235567e-05 2.6982675641775133e-05 2.500877559185028e-05 2.9010579884052277e-05 2.9033824503421783e-05 2.6505024433135986e-05 2.7549931108951568e-05 2.7543949484825135e-05 2.64951653778553e-05 )
set w1_array = ( 6.998010113835335e-06 7.494925022125244e-06 6.0062063150107865e-06 7.009209081530571e-06 8.497995346784591e-06 7.992021799087525e-06 5.998745042830706e-06 8.496385723352431e-06 6.4967125505208964e-06 7.983349472284317e-06 7.998887658119201e-06 7.500655114650726e-06 6.497899726033211e-06 5.994800630956889e-06 5.995052106678486e-06 6.500875413417816e-06 7.99906587600708e-06 8.506583333015441e-06 7.504610180854797e-06 8.501978874206543e-06 7.494221091270446e-06 7.498248279094696e-06 7.4811584353446955e-06 7.5006010234355924e-06 8.501167953014373e-06 7.992837339639663e-06 6.497296825051308e-06 7.00370779633522e-06 8.508015334606171e-06 7.004100069403648e-06 8.498770207166671e-06 8.004526406526565e-06 8.485515773296355e-06 7.489925682544708e-06 6.485971719026565e-06 6.495966523885727e-06 8.500965893268584e-06 6.492353588342667e-06 6.991726741194725e-06 8.00004667043686e-06 6.4977235198020935e-06 6.010523069649935e-06 7.003940105438232e-06 7.5026062726974485e-06 6.499093383550644e-06 5.997875988483429e-06 7.502762287855148e-06 6.498302131891251e-06 8.502768933773041e-06 7.986155658960342e-06 8.503957450389862e-06 7.4971789717674254e-06 5.988618036732077e-06 )
set w2_array = ( 5.262004444003105e-05 5.545664098858834e-05 5.354130509495735e-05 5.436027494072914e-05 5.5075635105371475e-05 5.256206330657005e-05 5.3122798770666124e-05 5.248101297020912e-05 5.4892920434474944e-05 5.207316080853343e-05 5.4553764641284945e-05 5.250043681263924e-05 5.358498141169548e-05 5.5674514174461366e-05 5.54463954269886e-05 5.394480502605438e-05 5.302110731601715e-05 5.353466358780861e-05 5.485884964466095e-05 5.5057448565959935e-05 5.510071036219597e-05 5.4611492097377776e-05 5.564162957668305e-05 5.4951214075088503e-05 5.3021249070763586e-05 5.509415772557259e-05 5.359097266197205e-05 5.306783255934715e-05 5.403428450226784e-05 5.409630674123764e-05 5.553512221574783e-05 5.301172970235348e-05 5.2084118951112033e-05 5.2037668298929925e-05 5.519661083817482e-05 5.413877955079079e-05 5.45763296186924e-05 5.466297942399979e-05 5.215177142992615e-05 5.247534100711346e-05 5.405606257915497e-05 5.4247433573007586e-05 5.4922344923019414e-05 5.353023090958595e-05 5.3057301610708235e-05 5.492997547984123e-05 5.3537627398967745e-05 5.3602894246578215e-05 5.4063585072755815e-05 5.1997190121561286e-05 5.5040023267269135e-05 5.5036325961351396e-05 5.225051023438573e-05 )
set i = 53
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata NgSpicePipeline/out/w0-test.csv $w0_array[$&index]
    wrdata NgSpicePipeline/out/w1-test.csv $w1_array[$&index]
    wrdata NgSpicePipeline/out/w2-test.csv $w2_array[$&index]
    wrdata NgSpicePipeline/out/pw-test.csv pw
    wrdata NgSpicePipeline/out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> NgSpicePipeline/out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc