circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 3.003089725971222e-05 3.0078635811805724e-05 2.8714223206043244e-05 3.0021114349365235e-05 3.0030544996261596e-05 3.002698838710785e-05 3.0028878450393676e-05 3.003706693649292e-05 3.0032113790512084e-05 3.0023305416107176e-05 2.770894020795822e-05 2.931948572397232e-05 3.003191888332367e-05 3.0044699907302856e-05 3.0071396827697754e-05 3.0046052932739257e-05 3.0063249468803406e-05 2.712440848350525e-05 3.0027143955230713e-05 3.0093622803688048e-05 3.002678096294403e-05 3.0087777972221375e-05 3.00762939453125e-05 3.003153145313263e-05 3.0047264099121094e-05 3.0068206787109375e-05 3.0144789814949036e-05 3.002894639968872e-05 3.0067054629325866e-05 3.004757046699524e-05 3.0034370422363282e-05 3.0032447576522827e-05 3.0074219107627868e-05 3.0108655095100403e-05 2.765564888715744e-05 2.8131822049617768e-05 3.0032870173454285e-05 3.0081852674484255e-05 3.002598285675049e-05 3.007327675819397e-05 3.004163980484009e-05 3.0046781301498413e-05 2.9855991899967193e-05 3.0036014914512633e-05 3.0073704123497008e-05 3.003163456916809e-05 2.9923597872257234e-05 3.0036691427230834e-05 3.0054640769958497e-05 3.0041922926902772e-05 3.0030023455619814e-05 3.0038095116615294e-05 3.0024101734161378e-05 3.0024466514587404e-05 3.0059854984283446e-05 3.0035802721977233e-05 2.8300742506980898e-05 3.0034416913986204e-05 3.0035407543182374e-05 3.003806233406067e-05 3.0158214569091798e-05 3.0040152668952943e-05 3.0040503144264222e-05 2.479034222662449e-05 3.0033808946609496e-05 3.0020980834960937e-05 3.003972351551056e-05 3.00328928232193e-05 3.0026931166648864e-05 3.0034331679344177e-05 3.0131425857543944e-05 2.973910599946976e-05 3.0063263177871704e-05 3.0030182003974916e-05 2.9974691569805147e-05 3.0076081156730653e-05 3.003464102745056e-05 3.0046322345733642e-05 3.0022116899490357e-05 3.004226565361023e-05 2.896135360002518e-05 2.7793953716754913e-05 2.9913749396800995e-05 3.0090603828430177e-05 2.997529238462448e-05 2.9999357759952545e-05 3.002514362335205e-05 3.0059695243835448e-05 3.010136067867279e-05 3.0031207203865052e-05 3.0027903318405152e-05 3.0047307014465332e-05 3.0034284591674805e-05 3.007479727268219e-05 3.0043333172798158e-05 2.7701470255851747e-05 3.004004418849945e-05 3.0031375885009764e-05 3.004791855812073e-05 3.0070632696151735e-05 3.0069186687469482e-05 3.0057222843170166e-05 3.0027878284454346e-05 3.0089269876480104e-05 2.71384172141552e-05 2.9539422690868377e-05 3.0060030817985533e-05 3.0025062561035157e-05 3.0028185844421386e-05 3.0057861804962158e-05 3.0066028237342836e-05 2.6618097126483917e-05 2.9941871464252473e-05 3.0058457255363465e-05 3.0028070211410522e-05 3.0030218362808228e-05 2.941025644540787e-05 3.0031896829605104e-05 3.0200175046920778e-05 3.0024493336677552e-05 3.0021109580993652e-05 3.0032781958580017e-05 2.4922877978533506e-05 3.007216513156891e-05 3.0079903602600097e-05 3.0030418634414673e-05 3.0030943155288697e-05 3.002170503139496e-05 3.0023095607757568e-05 3.004136323928833e-05 3.0061137080192567e-05 3.003807008266449e-05 3.003620743751526e-05 3.0028926730155944e-05 2.666002705693245e-05 2.9967621862888335e-05 3.0062885284423827e-05 3.0028059482574463e-05 3.0007436275482177e-05 3.002089500427246e-05 3.0022082924842833e-05 3.0021787285804748e-05 3.0038026571273803e-05 3.0030417442321777e-05 2.5961924940347672e-05 3.0034470558166502e-05 3.00625604391098e-05 3.0035107731819152e-05 3.0084333419799804e-05 3.008064031600952e-05 3.0036665201187134e-05 3.0022119879722595e-05 3.0234811305999757e-05 3.0045053958892822e-05 3.0063445568084717e-05 3.0058146715164183e-05 2.9984958469867706e-05 3.0043575167655945e-05 3.003496527671814e-05 3.006472408771515e-05 2.5192017275840045e-05 2.9963914453983308e-05 3.0023541450500487e-05 3.007265627384186e-05 3.0031338334083556e-05 3.008442521095276e-05 3.002803385257721e-05 3.0032252073287963e-05 2.6174847781658173e-05 2.990219324827194e-05 3.007807731628418e-05 3.0036319494247436e-05 3.0048431158065797e-05 3.004139244556427e-05 3.0026175975799562e-05 3.0028132200241088e-05 3.0039048194885255e-05 3.0071099996566773e-05 3.0089319944381714e-05 3.003308892250061e-05 3.008613109588623e-05 3.0069433450698853e-05 3.0076683163642882e-05 3.0025155544281006e-05 3.0063244104385377e-05 2.999104768037796e-05 3.0035159587860108e-05 3.004675269126892e-05 3.0029322504997253e-05 2.657942533493042e-05 3.002584755420685e-05 3.002559721469879e-05 3.0045921802520753e-05 3.0056121945381166e-05 3.006234884262085e-05 3.0065728425979614e-05 3.0170323848724365e-05 3.007088541984558e-05 3.0039693117141723e-05 3.004736065864563e-05 2.613734841346741e-05 3.002781867980957e-05 3.0031440258026122e-05 3.00221848487854e-05 3.0075275897979738e-05 3.0027785301208497e-05 3.004485070705414e-05 3.0031062364578248e-05 2.8565432131290436e-05 2.9142150580883025e-05 3.0041348338127138e-05 2.4973295014351608e-05 3.0064231753349305e-05 2.8169434368610383e-05 2.5450973212718966e-05 3.0030330419540404e-05 2.961310535669327e-05 3.0038679242134095e-05 3.0034181475639343e-05 3.0042644739151002e-05 3.0023139715194702e-05 3.0087175965309142e-05 3.0031847953796386e-05 3.0035460591316223e-05 3.0032968521118164e-05 3.002993106842041e-05 3.0078998208045958e-05 3.002979040145874e-05 3.0080323219299317e-05 2.9983414709568024e-05 2.532774865627289e-05 3.0028873682022095e-05 3.0044649839401246e-05 3.004725456237793e-05 3.004179060459137e-05 3.00854629278183e-05 3.0108458995819092e-05 3.0213345885276794e-05 3.0039886236190796e-05 3.0030951499938964e-05 3.0033426880836488e-05 3.0043058395385743e-05 3.002796769142151e-05 3.0054305791854858e-05 3.0240894556045533e-05 3.002010703086853e-05 3.0029918551445006e-05 2.9877323806285857e-05 3.0069994926452635e-05 3.004590153694153e-05 2.9911732375621796e-05 2.9994184672832488e-05 3.0047399401664735e-05 2.8956129252910616e-05 3.0028139352798463e-05 2.996698051691055e-05 2.968963772058487e-05 3.007679283618927e-05 3.0032464265823363e-05 3.0025652050971985e-05 3.00250643491745e-05 3.0026538372039796e-05 3.0036168098449706e-05 3.0027549862861632e-05 )
set w1_array = ( 6.018140682950616e-06 6.01781614497304e-06 5.997047660872341e-06 6.018235174939036e-06 6.018256362527609e-06 6.0179584696888926e-06 6.018201684579253e-06 6.0179195776581766e-06 6.017996253445745e-06 6.01820252276957e-06 5.998660292476416e-06 5.994061263278126e-06 6.018087588250637e-06 6.017988355830312e-06 6.01748918555677e-06 6.0179123878479e-06 6.01748975366354e-06 5.987728511914611e-06 6.018026558682322e-06 6.017501385882497e-06 6.018083099275828e-06 6.017729494720698e-06 6.017407378181815e-06 6.018059900030494e-06 6.017786463722587e-06 6.017635570839048e-06 6.016420846804976e-06 6.018064612522721e-06 6.017673410475254e-06 6.0178944040089845e-06 6.0179680529981855e-06 6.0180467497557405e-06 6.017592832446098e-06 6.016400581225753e-06 5.99267322011292e-06 5.9927442986518145e-06 6.0180953647941355e-06 6.01771492883563e-06 6.018178382888437e-06 6.0176283251494165e-06 6.017855865880847e-06 6.0168661586940285e-06 6.01758685335517e-06 6.017927614971996e-06 6.0177868548780676e-06 6.0180485192686316e-06 6.017639510333538e-06 6.016512740403414e-06 6.01596643589437e-06 6.017799353227019e-06 6.017980271950364e-06 6.017801951617003e-06 6.018075425177813e-06 6.018191644921899e-06 6.017481213435531e-06 6.017788726836443e-06 5.988888287916779e-06 6.018131211400032e-06 6.0178469996899364e-06 6.018017226830125e-06 6.015279902145267e-06 6.0178758706897495e-06 6.017818361520767e-06 6.000319238752127e-06 6.017969096079469e-06 6.0182702764868735e-06 6.017993962392211e-06 6.018081339076161e-06 6.017998609691858e-06 6.017895782366395e-06 6.015908498317003e-06 5.991439487785101e-06 6.017425762489438e-06 6.018168427050114e-06 6.017632078379392e-06 6.0152703281491995e-06 6.018067797645926e-06 6.017968360334635e-06 6.018214313313365e-06 6.017744051292539e-06 5.997480800375343e-06 6.005153110250831e-06 6.01813399605453e-06 6.017631119117141e-06 6.016682175919413e-06 6.017517786473036e-06 6.0181433837860825e-06 6.0176317058503625e-06 6.014390842989087e-06 6.018126852810383e-06 6.018134219571948e-06 6.01768222078681e-06 6.017812931910157e-06 6.0179305300116535e-06 6.018067751079798e-06 5.986589709296823e-06 6.0177255924791094e-06 6.0179182644933465e-06 6.017949296161532e-06 6.01753986813128e-06 6.01760077662766e-06 6.017588473856449e-06 6.018073478713632e-06 6.017679017037153e-06 5.992580031976104e-06 5.997640950605273e-06 6.0174305867403745e-06 6.018035909160971e-06 6.0179079454392195e-06 6.017809439450502e-06 6.017852382734418e-06 5.984364537522197e-06 6.017971722409129e-06 6.017669824883342e-06 6.017987824976444e-06 6.017968993633986e-06 5.990320354700089e-06 6.018134107813239e-06 6.015364047139883e-06 6.01810465939343e-06 6.018273200839758e-06 6.0179337337613106e-06 5.977593868970871e-06 6.017666602507234e-06 6.017575453966856e-06 6.017886739224195e-06 6.018187528476119e-06 6.017423937097192e-06 6.0182269141078e-06 6.0177072640508416e-06 6.017715347930789e-06 6.01783013343811e-06 6.01810415647924e-06 6.018093222752214e-06 5.999549128115177e-06 6.017829453572631e-06 6.0175122451037165e-06 6.017987890169024e-06 6.016588103026152e-06 6.018226960673928e-06 6.018269317224622e-06 6.016938131302595e-06 6.018140356987714e-06 6.018128259107471e-06 5.986174944788218e-06 6.017853612080216e-06 6.017807548865676e-06 6.017933184280992e-06 6.017838897183538e-06 6.01754124648869e-06 6.017980225384236e-06 6.018230807036161e-06 6.014610644429922e-06 6.0180457346141335e-06 6.017469869926572e-06 6.0175568461418155e-06 6.014408985152841e-06 6.0177271477878096e-06 6.017977980896831e-06 6.017601633444428e-06 5.978357860818505e-06 6.017141131684184e-06 6.0160208437591795e-06 6.017993217334151e-06 6.017525013536215e-06 6.017625410109759e-06 6.018095895648002e-06 6.0179529003798965e-06 5.982872223481536e-06 6.016923090443015e-06 6.018027666956187e-06 6.017840899527073e-06 6.018004486337304e-06 6.018031112849712e-06 6.018066084012389e-06 6.018022581934929e-06 6.017838561907411e-06 6.017513372004032e-06 6.017256056889892e-06 6.017990088090301e-06 6.017782738432288e-06 6.017752526327968e-06 6.0176934618502854e-06 6.01807046122849e-06 6.016456190496683e-06 6.017707487568259e-06 6.017966544255615e-06 6.018024733290076e-06 6.0178969278931615e-06 5.992426885291934e-06 6.018217740580439e-06 6.018181502819062e-06 6.017856992781162e-06 6.017623621970415e-06 6.017537521198392e-06 6.01771460287273e-06 6.015957783907652e-06 6.0177078600972895e-06 6.018054218962788e-06 6.017840033397079e-06 5.985427232459188e-06 6.01820950768888e-06 6.018087243661284e-06 6.018258234485984e-06 6.0177385751158e-06 6.018163351342082e-06 6.017711222171784e-06 6.018124524503946e-06 5.992834087461233e-06 5.997483408078551e-06 6.0179719273000955e-06 6.009874971583485e-06 6.017759213224053e-06 5.998212205246091e-06 6.000183833763004e-06 6.017927102744579e-06 5.993598852306604e-06 6.017745215445757e-06 6.017939228564501e-06 6.017690127715469e-06 6.018188832327723e-06 6.0164188258349895e-06 6.017974376678467e-06 6.017943577840925e-06 6.018035294488072e-06 6.018052849918604e-06 6.017612082883716e-06 6.018090903759003e-06 6.017763981595635e-06 6.017371112480759e-06 5.985142685472966e-06 6.018109502270818e-06 6.017764661461115e-06 6.017733750864864e-06 6.017350744456053e-06 6.017584580928087e-06 6.015909997746349e-06 6.014541242271662e-06 6.017934395000339e-06 6.017977142706514e-06 6.018007010221481e-06 6.018009217455983e-06 6.018030060455203e-06 6.017118789255619e-06 5.997577359899878e-06 6.018277624621987e-06 6.018194392323494e-06 6.015549510717392e-06 6.017569018527866e-06 6.01780241727829e-06 6.016283728182316e-06 6.017029950395226e-06 6.017632031813264e-06 5.992982167750597e-06 6.017947163432837e-06 6.015397975221276e-06 5.994757948443294e-06 6.01787162385881e-06 6.018224995583296e-06 6.018093446269631e-06 6.018181437626481e-06 6.018255868926644e-06 6.0178836844861504e-06 6.018213503062725e-06 )
set w2_array = ( 5.200588548183441e-05 5.201187250763178e-05 5.589350032806397e-05 5.200466798432171e-05 5.200723842997104e-05 5.2002345100976524e-05 5.20062296660617e-05 5.200510171055794e-05 5.200473999604583e-05 5.20046431068331e-05 5.287565119564533e-05 5.533321130275727e-05 5.2005398786626755e-05 5.200750297494233e-05 5.200485975481569e-05 5.20069424752146e-05 5.2003243656829e-05 5.3638849049806594e-05 5.2002495037391783e-05 5.201271381787956e-05 5.200392237026244e-05 5.201376138441264e-05 5.200978577136993e-05 5.20052447039634e-05 5.2005877658724784e-05 5.200623091123998e-05 5.204935858678073e-05 5.200426322314888e-05 5.200649657100439e-05 5.200706849247217e-05 5.200326753687113e-05 5.200410444661975e-05 5.200709427613765e-05 5.204214292857796e-05 5.322090390324593e-05 5.322202844917774e-05 5.200594145618379e-05 5.201131628453731e-05 5.2004822308197614e-05 5.200735622644424e-05 5.200544642936438e-05 5.202294926811009e-05 5.2009314820170404e-05 5.2004311341792346e-05 5.2009835839271544e-05 5.2003932449035346e-05 5.2003107221797105e-05 5.203342521376908e-05 5.205069235526025e-05 5.200497639086097e-05 5.200243218522519e-05 5.200424517132342e-05 5.200257895328104e-05 5.200481501314789e-05 5.200271969754249e-05 5.200366511382163e-05 5.4674601018428804e-05 5.200672022718936e-05 5.2003139335662125e-05 5.2006312916986644e-05 5.2082972278818485e-05 5.200533346366137e-05 5.200487038772553e-05 5.290930902957916e-05 5.200486194528639e-05 5.200498551130295e-05 5.200643868651241e-05 5.2005576221272345e-05 5.20028394497931e-05 5.200347231980413e-05 5.2059796114452184e-05 5.4246565103530887e-05 5.2007226551882924e-05 5.200571216735989e-05 5.200035108812153e-05 5.2073439206928016e-05 5.2006064129061995e-05 5.2007639181800186e-05 5.200447438191622e-05 5.200455259997398e-05 5.289388769865036e-05 5.260154174268246e-05 5.19897322403267e-05 5.201327995676547e-05 5.20287611996755e-05 5.2002854365855455e-05 5.200398169551045e-05 5.200464686844498e-05 5.2103416847996414e-05 5.200520587526262e-05 5.200450068060308e-05 5.200491218920797e-05 5.2003550179302693e-05 5.201250704657286e-05 5.200813775509596e-05 5.4120531260967256e-05 5.200398002658039e-05 5.200299296528101e-05 5.2007776105776426e-05 5.2005416225641966e-05 5.20059621874243e-05 5.200384612753987e-05 5.200409259460866e-05 5.201350982580334e-05 5.322414736449718e-05 5.5974076688289646e-05 5.200175424758345e-05 5.20021654497832e-05 5.2002037150785325e-05 5.2006354046985505e-05 5.200870260316878e-05 5.411750215291977e-05 5.19922129875049e-05 5.200489694066346e-05 5.200209982041269e-05 5.20033333748579e-05 5.42003887295723e-05 5.200606822967529e-05 5.209215683117509e-05 5.200358552020043e-05 5.2005399190820754e-05 5.200429581291973e-05 5.463745188713074e-05 5.200761943496763e-05 5.2008538546040656e-05 5.2002356770448384e-05 5.200660424306988e-05 5.200539941247553e-05 5.200500407814979e-05 5.200407536420971e-05 5.2005860480479894e-05 5.200359576195478e-05 5.2006845201365645e-05 5.200403214152902e-05 5.2884127482771874e-05 5.199469964765012e-05 5.2003543197177346e-05 5.200300396978855e-05 5.203098674397916e-05 5.200430845376104e-05 5.200556860677898e-05 5.2020317065529525e-05 5.200772569235414e-05 5.2005028864368795e-05 5.3649603113532065e-05 5.2002985129132865e-05 5.2007282800041135e-05 5.200414965767413e-05 5.20143379997462e-05 5.2008300084620714e-05 5.200561090372503e-05 5.20048341602087e-05 5.212400428019464e-05 5.200828136131167e-05 5.200293557625264e-05 5.200358332972973e-05 5.209932981431484e-05 5.2004647474735975e-05 5.200470278412104e-05 5.200507703516632e-05 5.5192950248718263e-05 5.201548090390861e-05 5.2048343583941456e-05 5.201286238525063e-05 5.2002185359597206e-05 5.2010820397175844e-05 5.200385908782482e-05 5.20036611892283e-05 5.464171224832535e-05 5.2024984723888337e-05 5.201543773338199e-05 5.200329274032265e-05 5.200857610348612e-05 5.200723508559167e-05 5.200290985126048e-05 5.2002661976031955e-05 5.2004761522635816e-05 5.200513928104192e-05 5.201609447039664e-05 5.20043688416481e-05 5.201403678394854e-05 5.200815262552351e-05 5.2009293782524766e-05 5.2002743375487626e-05 5.203608986269683e-05 5.199718763772398e-05 5.200343396048993e-05 5.2008427536115046e-05 5.2002197524532674e-05 5.3230404809117315e-05 5.2005528428591785e-05 5.200498907081783e-05 5.2006324443034826e-05 5.200409494154155e-05 5.2003833975642915e-05 5.2006760053336617e-05 5.206789041869342e-05 5.200788422115147e-05 5.2007103129290046e-05 5.200643970351666e-05 5.579475766420365e-05 5.200604463648051e-05 5.2004554014652966e-05 5.2005154027603566e-05 5.2009560394100844e-05 5.200534330774099e-05 5.200473899208009e-05 5.200582103896886e-05 5.322877113521099e-05 5.592939400672913e-05 5.2006564469076695e-05 5.262277517467737e-05 5.2007021632045505e-05 5.2876618966460226e-05 5.290041822195053e-05 5.200283171795308e-05 5.329659582674503e-05 5.200387992337346e-05 5.200398769974709e-05 5.200416652299464e-05 5.200430634152144e-05 5.203898701444268e-05 5.200276636891067e-05 5.200498270150274e-05 5.2004950587637724e-05 5.200358885154128e-05 5.200878333766013e-05 5.200420576240867e-05 5.201158596016467e-05 5.200786833371967e-05 5.365664526820183e-05 5.200486972928047e-05 5.200517947878688e-05 5.2005371731705965e-05 5.200798716023564e-05 5.201059262733907e-05 5.205639948975295e-05 5.2118287790566685e-05 5.2005852898582815e-05 5.200259911082685e-05 5.20036764703691e-05 5.20073683001101e-05 5.200353078451008e-05 5.20156485857442e-05 5.609746485948563e-05 5.2005233777686954e-05 5.2006416116841135e-05 5.2066974612884225e-05 5.200569097977131e-05 5.200577280949801e-05 5.204321578983217e-05 5.201782715227455e-05 5.20044902889058e-05 5.3242457404732704e-05 5.200250763911754e-05 5.2068176405504343e-05 5.538161945343018e-05 5.201217829342931e-05 5.20073514347896e-05 5.20037531433627e-05 5.2004648133181035e-05 5.200645622983575e-05 5.2003787239082154e-05 5.2005886779166755e-05 )
set i = 264
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc