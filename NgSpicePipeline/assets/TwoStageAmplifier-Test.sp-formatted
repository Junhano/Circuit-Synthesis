circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.6536730825901032e-05 2.998101830482483e-05 2.997842013835907e-05 2.5374089516699315e-05 2.997599184513092e-05 2.9980512857437132e-05 2.9986957907676696e-05 2.9982829093933104e-05 2.9177125990390777e-05 2.9977973103523255e-05 2.9964420795440674e-05 2.997624456882477e-05 2.9985908269882202e-05 2.998060643672943e-05 2.9987391233444214e-05 2.9956609010696412e-05 2.9948145747184753e-05 2.755858600139618e-05 2.9987056851387024e-05 2.9978739619255066e-05 2.998435914516449e-05 2.9965288639068605e-05 2.9981340765953063e-05 2.9185968339443206e-05 2.996881604194641e-05 2.9982073903083802e-05 2.997192442417145e-05 2.714110225439072e-05 2.997194588184357e-05 2.9965572953224184e-05 2.9933746457099914e-05 2.9544475078582763e-05 2.995270371437073e-05 2.997159957885742e-05 2.9987813234329225e-05 2.830349624156952e-05 2.996794521808624e-05 2.99714195728302e-05 2.989218473434448e-05 2.9963406920433043e-05 2.9968112111091615e-05 2.998726427555084e-05 2.9986135363578796e-05 2.92136949300766e-05 2.998704135417938e-05 2.998509645462036e-05 2.9954273104667663e-05 2.9971826672554017e-05 2.6262074857950212e-05 2.561477590352297e-05 2.9547941386699676e-05 2.675064504146576e-05 2.9980968832969665e-05 )
set w1_array = ( 5.996443828567863e-06 5.989966601133346e-06 5.989830404520035e-06 5.997572414577007e-06 5.990847762674093e-06 5.990542773157358e-06 5.990231459960341e-06 5.990165960043669e-06 5.997045397758484e-06 5.989794995635748e-06 5.990131175145507e-06 5.990082969889045e-06 5.990420695394277e-06 5.9901825748383995e-06 5.990134695544839e-06 5.9913923349231485e-06 5.9899447336792946e-06 6.004899324849248e-06 5.9902843590825795e-06 5.990871716290713e-06 5.990594740957022e-06 5.989326577633619e-06 5.990367451682687e-06 5.999113176018e-06 5.9899813067168e-06 5.990747198462486e-06 5.990420965477824e-06 5.9947371613234285e-06 5.990265872329474e-06 5.9897326156497e-06 5.990212814882397e-06 5.99426556751132e-06 5.989347262308002e-06 5.990702215582132e-06 5.990006154403091e-06 5.992669001221657e-06 5.9899615719914435e-06 5.990766551345587e-06 5.99446077272296e-06 5.990104399621487e-06 5.989757882431149e-06 5.99005451798439e-06 5.989853780716657e-06 5.9923401512205605e-06 5.990012058988214e-06 5.990758541971445e-06 5.989395420998335e-06 5.990220544859767e-06 5.9898205418139695e-06 6.018232129514217e-06 5.990715133026243e-06 5.988632965832949e-06 5.990533106029034e-06 )
set w2_array = ( 5.3394208312034605e-05 5.1980127215385436e-05 5.1977978128939864e-05 5.2868433594703676e-05 5.1986881662160156e-05 5.1989793110638856e-05 5.198436233401298e-05 5.1984233109280464e-05 5.4403744101524355e-05 5.1977910928428175e-05 5.1989036746323107e-05 5.1987079026177524e-05 5.19875969029963e-05 5.198566464707255e-05 5.1981937691569325e-05 5.198862845823169e-05 5.208900184929371e-05 5.4910150051116946e-05 5.207771826535463e-05 5.1988297449424864e-05 5.198930700868368e-05 5.288728874921799e-05 5.1988386072218416e-05 5.4912334889173506e-05 5.198636203818023e-05 5.1989595733582975e-05 5.198969563469291e-05 5.336202497780323e-05 5.198914809525013e-05 5.198049456253648e-05 5.2379709046334024e-05 5.3797877430915834e-05 5.198767917603254e-05 5.198684314638376e-05 5.197888336703181e-05 5.328339166939259e-05 5.1986654270440336e-05 5.1985905898734924e-05 5.4350981295108796e-05 5.198893155157566e-05 5.198081287182867e-05 5.198059836216271e-05 5.1979288943111894e-05 5.318790873885155e-05 5.198002465441823e-05 5.198959137871861e-05 5.197517358325422e-05 5.1988968906924125e-05 5.196622700989246e-05 5.542201715707779e-05 5.248030659556389e-05 5.222848909348249e-05 5.1984217476099726e-05 )
set i = 53
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc