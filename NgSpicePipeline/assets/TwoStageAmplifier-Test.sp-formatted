circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 2.4976551532745363e-05 2.5527541115880014e-05 2.552734971046448e-05 2.6513210982084276e-05 3.0156793594360352e-05 2.5988688841462135e-05 2.8072281777858735e-05 3.0103967785835266e-05 2.9142582714557647e-05 2.8100934326648712e-05 2.7023875266313554e-05 2.808302253484726e-05 3.0092893242836e-05 2.7007277458906173e-05 2.700919345021248e-05 2.8642365336418152e-05 2.6498477309942245e-05 2.6093504279851914e-05 2.5998701453208924e-05 2.5011920522665605e-05 3.010811507701874e-05 2.804202437400818e-05 2.7076499313116074e-05 2.7053591758012773e-05 2.7581117153167723e-05 2.911494702100754e-05 2.605176590383053e-05 2.6509613245725634e-05 2.6524984389543534e-05 2.8601067364215852e-05 2.70456899702549e-05 2.7566897571086883e-05 2.5535548850893975e-05 2.8570670187473296e-05 2.760750323534012e-05 2.9084682762622835e-05 2.4994727834127845e-05 2.6511940509080888e-05 2.599267266690731e-05 2.9590016901493073e-05 3.0153316855430603e-05 2.7049337178468703e-05 2.7565610110759736e-05 2.9621706902980806e-05 2.7051565498113633e-05 2.6031096503138544e-05 2.9136351048946382e-05 2.653229370713234e-05 2.5999954864382746e-05 2.7059938609600067e-05 2.6544078737497332e-05 2.9655009806156158e-05 2.7568815648555757e-05 )
set w1_array = ( 7.0141916573047635e-06 8.01703816652298e-06 7.514540314674377e-06 6.533192306756973e-06 8.506940066814422e-06 6.534343719482422e-06 8.02515944838524e-06 8.519265115261078e-06 6.043003247119487e-06 8.508077025413512e-06 7.522027254104614e-06 7.032304018735886e-06 7.032566726207733e-06 6.048042945563793e-06 6.537543147802353e-06 8.5065878033638e-06 6.533311292529106e-06 8.497790902853011e-06 6.040361047722399e-06 6.53257081657648e-06 8.513620853424072e-06 6.04252742510289e-06 8.512925863265991e-06 6.538513660430908e-06 7.0315361618995665e-06 6.0389407388865945e-06 6.0428812857717274e-06 7.5194775164127345e-06 6.5349467322230335e-06 8.021021693944931e-06 8.026153653860091e-06 7.523981243371964e-06 8.010199576616287e-06 6.039295121096074e-06 8.505583167076111e-06 6.53876843303442e-06 7.51129350066185e-06 7.023774892091751e-06 6.0478576449677345e-06 7.030656620860099e-06 6.036309505812824e-06 7.029392182826995e-06 8.020632773637771e-06 6.545666702091693e-06 8.019037008285522e-06 7.026448756456375e-06 8.508088648319244e-06 6.0406750570982695e-06 7.515514999628067e-06 6.042239734902978e-06 8.016311436891556e-06 6.041793580166995e-06 6.539889447391033e-06 )
set w2_array = ( 5.2955478206276895e-05 5.2003543868660926e-05 5.4944355815649034e-05 5.342505431175232e-05 5.493786847591401e-05 5.195642906054854e-05 5.247066847234964e-05 5.199598218128085e-05 5.532973784208298e-05 5.297072158753872e-05 5.245762787014246e-05 5.441871544718743e-05 5.389839291572571e-05 5.193135818466544e-05 5.194492684677243e-05 5.494074049592018e-05 5.2436041772365566e-05 5.494962754845619e-05 5.292516104876995e-05 5.4444224625825884e-05 5.247189237177372e-05 5.240029055252671e-05 5.201186297647655e-05 5.441583237051964e-05 5.539498403668404e-05 5.386752313375473e-05 5.490681114792824e-05 5.246091143786907e-05 5.392430931329727e-05 5.3945648670196536e-05 5.199629393219948e-05 5.443627426028252e-05 5.3968454390764235e-05 5.288307563960552e-05 5.4459110230207444e-05 5.339617691934109e-05 5.1987039063125844e-05 5.3435762897133825e-05 5.194948785007e-05 5.340725412964821e-05 5.43432503938675e-05 5.4428844809532166e-05 5.3455411106348036e-05 5.5345082193613053e-05 5.345906522870064e-05 5.4931270569562916e-05 5.396120810508728e-05 5.390847471356392e-05 5.2956135138869285e-05 5.439621180295944e-05 5.3960345268249516e-05 5.5317761182785035e-05 5.4409592658281324e-05 )
set i = 53
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc