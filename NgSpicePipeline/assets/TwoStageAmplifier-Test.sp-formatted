circuit: TwoStageAmplifier
.include ../assets/45nm_CS.pm
.option TEMP=27C

V1 net14 0 dc 1
V2 net10 0 dc 1
V3 net4 0 dc 2.4
V4 net3 0 dc 2.1
V5 net2 0 dc 1.5
V6 net9 0 dc 700m
V7 vdd 0 dc 3.3

mn0 out1 net14 0 0 NMOS W=2.4u L=45n
mn1 out2 net10 0 0 NMOS W=2.4u L=45n

mn9 out4 net2 net11 0 NMOS W=58.5u L=117n
mn6 out3 net2 net6 0 NMOS W=58.5u L=117n

mn8 net11 net13 net8 0 NMOS W=25u L=45n
mn5 net6 net1 net8 0 NMOS  W=25u L=45n

mn7 net8 net9 0 0 NMOS W=52u L=45n

V8 net13 0 dc 1.2 ac 1
V9 net1 0 dc 1.2 ac 1

mp5 out1 out3 vdd vdd PMOS W=6u L=45n
mp4 out2 out4 vdd vdd PMOS W=6u L=45n

mp1 net12 net4 vdd vdd PMOS W=13u L=45n
mp0 net7 net4 vdd vdd PMOS W=13u L=45n

mp3 out4 net3 net12 vdd PMOS W=94u L=180n
mp2 out3 net3 net7 vdd PMOS W=94u L=180n

C4 out3 out1 14p
C3 out4 out2 14p
C1 out2 0 5p
C0 out1 0 5p

.control
set w0_array = ( 3.0047725439071656e-05 3.0034525394439696e-05 3.0040310621261596e-05 3.0036730766296388e-05 2.960497170686722e-05 3.0030055046081543e-05 3.0051363110542296e-05 3.0053558945655824e-05 3.0035656690597533e-05 3.0050895810127258e-05 3.0097479820251463e-05 3.0038326382637025e-05 3.0047249794006347e-05 3.0026720762252806e-05 3.0051000714302062e-05 3.0040947794914245e-05 3.003537118434906e-05 3.0050107836723328e-05 3.0032062530517578e-05 3.0049939155578612e-05 3.00417959690094e-05 3.0094835758209228e-05 3.0057430863380432e-05 3.0079225897789e-05 2.7977725565433503e-05 3.0047553777694703e-05 3.005148470401764e-05 3.0086427330970763e-05 3.0035284757614135e-05 3.0035059452056884e-05 2.9605422019958495e-05 3.0034837126731874e-05 3.0077534914016724e-05 3.006238102912903e-05 3.0051634907722473e-05 3.004403531551361e-05 3.004262387752533e-05 3.004258990287781e-05 3.003259539604187e-05 3.0040390491485596e-05 2.60379259288311e-05 2.450005114078522e-05 3.0022173523902893e-05 3.0082204937934876e-05 3.0038480162620543e-05 3.0059101581573487e-05 3.0040299892425536e-05 2.7689666450023652e-05 2.958828389644623e-05 3.004041850566864e-05 2.515925958752632e-05 3.008775532245636e-05 3.0085888504981995e-05 2.9945755004882814e-05 3.0046151876449585e-05 3.003611207008362e-05 3.0044970512390138e-05 3.00359171628952e-05 2.8821536898612975e-05 3.0045203566551207e-05 )
set w1_array = ( 6.023989561013878e-06 6.023557259701193e-06 6.023288689553738e-06 6.022908835671842e-06 6.0166343292221425e-06 6.023074569180608e-06 6.02362275030464e-06 6.023338426835835e-06 6.023382529616356e-06 6.023384653031826e-06 6.023438860662281e-06 6.02326509449631e-06 6.023199077695608e-06 6.023058191873133e-06 6.02324496395886e-06 6.023476998321712e-06 6.023377132602036e-06 6.023741447366774e-06 6.023612417280674e-06 6.023362217471004e-06 6.023658387362957e-06 6.023352578282356e-06 6.023340568877757e-06 6.023354641161859e-06 6.01256160903722e-06 6.0237508537247775e-06 6.02331580966711e-06 6.023438129574061e-06 6.023381779901683e-06 6.023535136133433e-06 6.008888859301805e-06 6.023270552046597e-06 6.02345388289541e-06 6.0245589716359975e-06 6.023796423338353e-06 6.023048599250615e-06 6.023405370302499e-06 6.023319185711443e-06 6.023220651783049e-06 6.0229798397049305e-06 5.9985917937010526e-06 5.995555379427969e-06 6.022900397889316e-06 6.023749168030918e-06 6.023456509225071e-06 6.02384320832789e-06 6.023642512969673e-06 6.001153321936727e-06 6.0193539867177606e-06 6.022972114384174e-06 5.992509339936077e-06 6.023254635743797e-06 6.02341843675822e-06 6.02267184201628e-06 6.023275800049305e-06 6.022940658964217e-06 6.02348646055907e-06 6.023535643704236e-06 6.014932290650904e-06 6.023355241864919e-06 )
set w2_array = ( 5.1989375317469235e-05 5.1996298860758544e-05 5.1999022111296655e-05 5.1995797960087654e-05 5.298988132178783e-05 5.199292454496026e-05 5.1990625906735656e-05 5.19936527851969e-05 5.199318365287036e-05 5.199709096364677e-05 5.2035749368369575e-05 5.1999448242597284e-05 5.19945440525189e-05 5.199309666641056e-05 5.199425860028714e-05 5.199691586941481e-05 5.199170028045773e-05 5.199260274134576e-05 5.199723434820771e-05 5.199738872423768e-05 5.199154707789421e-05 5.2028785079717636e-05 5.199404482729733e-05 5.2009963545016944e-05 5.224257715791464e-05 5.199019094184041e-05 5.2020351513288915e-05 5.20301984352991e-05 5.199958860874176e-05 5.1998209903016686e-05 5.400290673971176e-05 5.199207119364291e-05 5.2005404647439716e-05 5.1987474523484703e-05 5.199000320676714e-05 5.199513178970664e-05 5.1997794000431894e-05 5.200251165498048e-05 5.199449738115072e-05 5.199545728322118e-05 5.304689072072506e-05 5.271589490026235e-05 5.199386955052614e-05 5.1999043259769676e-05 5.1998163212090726e-05 5.199316145479679e-05 5.199070527218282e-05 5.345569148659706e-05 5.2605046182870864e-05 5.199543199501932e-05 5.5703791379928594e-05 5.202354237716645e-05 5.201566340401768e-05 5.198996846564114e-05 5.199699662998319e-05 5.199587722122669e-05 5.199427854269743e-05 5.199770712479949e-05 5.2548786602914334e-05 5.199789349734783e-05 )
set i = 60
let index = 1
repeat $i
    alter @mn5[w] = $w0_array[$&index]
	alter @mn8[w] = $w0_array[$&index]
	alter @mn7[w] = $w1_array[$&index]
	alter @mp5[w] = $w2_array[$&index]
	alter @mp4[w] = $w2_array[$&index]
    op
    let id2 = @mp4[id]
    let id1 = @mn8[id]
    let pw = (id1+id2)*3.3
    let av = v(out2)/v(net1)
    wrdata ../out/w0-test.csv $w0_array[$&index]
    wrdata ../out/w1-test.csv $w1_array[$&index]
    wrdata ../out/w2-test.csv $w2_array[$&index]
    wrdata ../out/pw-test.csv pw
    wrdata ../out/a0-test.csv av

    ac dec 1000 1G 100G
    let resp = db(v(out2)/v(net1))
    let measurement_point = vecmax (resp) - 3.0
    meas AC upper_3dB WHEN resp = measurement_point
    print upper_3dB >> ../out/bw-test.csv
    set appendwrite
    let index = index + 1

end
.endc